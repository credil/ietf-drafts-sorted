<?xml version="1.0"?>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

<?rfc toc="no"?>
<?rfc symrefs="no"?>
<?rfc compact="yes" ?>
<?rfc sortrefs="yes" ?>
<?rfc strict="yes" ?>
<?rfc linkmailto="yes" ?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" >

<?rfc toc="no"?>
<?rfc symrefs="yes"?>
<?rfc compact="yes" ?>
<?rfc subcompact="yes" ?>
<?rfc sortrefs="yes" ?>
<rfc ipr="trust200902" docName="draft-nir-ipsecme-erx-07" category="exp" updates="5996">
  <front>
    <title abbrev="ERX for IKE">An IKEv2 Extension for Supporting ERP</title>
    <author initials="Y." surname="Nir" fullname="Yoav Nir">
      <organization abbrev="Check Point">Check Point Software Technologies Ltd.</organization>
      <address>
        <postal>
          <street>5 Hasolelim st.</street>
          <city>Tel Aviv</city>
          <code>67897</code>
          <country>Israel</country>
        </postal>
        <email>ynir@checkpoint.com</email>
      </address>
    </author>
    <author initials="Q." surname="Wu" fullname="Qin Wu">
      <organization abbrev="Huawei">Huawei Technologies Co., Ltd.</organization>
      <address>
        <postal>
          <street>101 Software Avenue, Yuhua District</street>
          <city>Nanjing, JiangSu</city>
          <code>210012</code>
          <country>China</country>
        </postal>
        <email>sunseawq@huawei.com</email>
      </address>
    </author>
    <date year="2012"/>
    <area>Security Area</area>
    <keyword>Internet-Draft</keyword>
    <abstract>
      <t> This document updates the IKEv2 protocol, described in RFC 5996. This extension allows an 
        IKE Security Association (SA) to be created and authenticated using the EAP 
        Re-authentication Protocol extension as described in RFC 6696.</t>
    </abstract>
  </front>
  <middle>
    <!-- ====================================================================== -->
    <section anchor="introduction" title="Introduction">
      <t> IKEv2, as specified in section 2.16 of <xref target="RFC5996"/>, allows authentication of 
        the initiator using an EAP method. Using EAP significantly increases the count of 
        round-trips required to establish the IPsec SA, and also may require user interaction. This 
        makes it inconvenient to allow a single remote access client to create multiple IPsec 
        tunnels with multiple IPsec gateways that belong to the same domain.</t> 
      <t> The EAP Re-authentication Protocol (ERP), as described in <xref target="RFC6696"/>, 
        allows an EAP peer to authenticate to multiple authenticators, while performing the full 
        EAP method only once. Subsequent authentications require fewer round-trips and no user 
        interaction.</t>
      <t> Bringing these two technologies together allows a remote access IPsec client to create
        multiple tunnels with different gateways that belong to a single domain, as well as using 
        the keys from other contexts of using EAP, such as network access within the same domain,
        to transparently connect to VPN gateways within this domain.</t>
      <section anchor="mustshouldmay" title="Conventions Used in This Document">
        <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT",
          "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described
          in <xref target="RFC2119"/>.</t>
      </section>
      </section>
      <section anchor="scenarios" title="Usage Scenarios">
        <t> This work is motivated by the following scenarios:<list style="symbols">
          <t> Multiple tunnels for a single remote access VPN client. Suppose a company has offices
            in New York City, Paris, and Shanghai. For historical reasons, the email server is 
            located in the Paris office, while most of the servers hosting the company's intranet
            are located in Shanghai, and the finance department servers are in NYC. An employee 
            using remote access VPN may need to connect to servers from all three locations. While
            it is possible to connect to a single gateway, and have that gateway route the requests
            to the other gateways (perhaps through site to site VPN), this is not efficient, and it
            is more desirable to have the client initiate three different tunnels. It is, however, 
            not desirable to have the user type in a password three times.</t>
          <t> Roaming. In these days of mobile phones and tablets, users often move from the 
            wireless LAN in their office, where access may be granted through 802.1x, to a cellular
            network where VPN is necessary and back again. Both the VPN server and the 802.1x
            access point are authenticators that connect to the same Authentication, Authorization 
            and Accounting (AAA) servers. So it makes sense to make the transition smooth, without 
            requiring user interaction. The device still needs to detect whether it is within the 
            protected network, in which case it should not use VPN, but this process is beyond the 
            scope of this document. <xref target="SecureBeacon"/> is a now-abandoned attempt at 
            this.</t></list></t>
      </section>
      <section anchor="outline" title="Protocol Outline">
        <t> Supporting ERX requires an EAP payload in the first IKE_AUTH request. This is a 
          deviation from the rules in RFC 5996, so support needs to be indicated through a Notify 
          payload in the IKE_SA_INIT response. This Notify serves the same purpose as the 
          EAP-Initiate/Re-auth-Start message of ERX, as specified in section 5.3.1 of RFC 6696. The 
          domain name included in the Domain-Name TLV as specified in section 5.3.1.1 of the same 
          document.</t>
        <t> A supporting initiator that has unexpired keys for this domain will send the 
          EAP_Initiate/Re-auth message in an EAP payload in the first IKE_AUTH request.</t>
        <t> The responder sends the EAP payload content to a backend AAA server, and receives the
          rMSK and an EAP-Finish/Re-auth message. It then forwards the EAP-Finish/Re-auth message 
          to the Initiator in an EAP payload within the first IKE_AUTH response.</t>
        <t> The initiator then sends an additional IKE_AUTH request, that includes the AUTH payload
          which has been calculated using the rMSK in the role of the MSK as described in sections
          2.15 and 2.16 of RFC 5996. The responder replies similarly, and the IKE_AUTH exchange is 
          finished.</t>
        <t> The following figure is adapted from appendixes C.1 and C.3 of RFC 5996, with most of 
          the optional payloads removed. Note that the EAP_Initiate/Re-auth message is added.</t>
        <figure>
            <artwork><![CDATA[
            
IKE_SA_INIT Exchange:
| init request         --> SA, KE, Ni,
|
| init response       <-- SA, KE, Nr,
|                         N[ERX_SUPPORTED]

IKE_AUTH Exchanges:
| first request       --> EAP(EAP_Initiate/Re-auth),
|                         IDi,
|                         SA, TSi, TSr
|
| first response      <-- IDr, [CERT+], AUTH,
|                         EAP(EAP-Finish/Re-auth)
|
| last request        --> AUTH
|
| last response       <-- AUTH,
|                         SA, TSi, TSr
            ]]></artwork>
        </figure>
        <t> The IDi payload MUST have ID Type ID_RFC822_ADDR and the data field MUST contain the 
          same value as the KeyName-NAI TLV in the EAP_Initiate/Re-auth message. See 
          <xref target="keyname_nai" /> for details.</t>
        <section anchor="eap_clarif" title="Clarification About EAP Codes">
          <t> Section 3.16 of RFC 5996 enumerates the EAP codes in EAP messages which are carried 
            in EAP payloads. The enumeration goes only to 4. It is not clear whether that list is 
            supposed to be exhaustive or not.</t>
          <t> To clarify, an implementation conforming to this specification MUST accept and 
            transmit EAP messages with at least the codes for Initiate and Finish (5 and 6) from
            RFC 6696, in addition to the four codes enumerated in RFC 5996. This document is 
            intentionally silent about other EAP codes that are neither enumerated in RFC 5996 nor 
            in that document.</t>
        </section>        
        <section anchor="keyname_nai" title="User Name in the Protocol">
          <t> The authors, as well as participants of the HOKEY and IPsecME working groups believe 
            that all use cases for this extension to IKE have a single backend AAA server doing 
            both the authentication and the re-authentication. The reasoning behind this is that
            IKE runs over the Internet, and would naturally connect to the user's home network.</t>
          <t> This section addresses instances where this is not the case.</t>  
          <t> Section 5.3.2 of RFC 6696 describes the EAP-Initiate/Re-auth packet, which in the 
            case of IKEv2 is carried in the first IKE_AUTH request. This packet contains the 
            KeyName-NAI TLV. This TLV contains the username used in authentication. It is relayed 
            to the AAA server in the AccessRequest message, and is returned from the AAA server in 
            the AccessAccept message.</t>
          <t> The username part of the NAI within the TLV is the EMSKName (<xref target="RFC5295"/>
            encoded in hexadecimal digits. The domain part is the domain name of the home domain of 
            the user. The username part is ephemeral in the sense that a new one is generated for 
            each full authentication. This ephemeral value is not a good basis for making policy 
            decisions, and they are also a poor source of user identification for the purposes of 
            logging.</t>
          <t> Instead, it is up to the implementation in the IPsec gateway to make policy decisions
            based on other factors. The following list is by no means exhaustive: <list style="symbols">
            <t> In some cases the home domain name may be enough to make policy decisions. If all 
              users with a particular home domain get the same authorization, then policy does not
              depend on the real user name. Meaningful logs can still be issued by correlating VPN 
              gateway IKE events with AAA servers access records.</t>
            <t> Sometimes users receive different authorizations based on groups they belong to.
              The AAA server can communicate such information to the VPN gateway, for example using 
              the CLASS attribute (<xref target="RFC2865"/>) in RADIUS and Diameter 
              (<xref target="RFC3588"/>). Logging again depends on correlation with AAA servers.</t>
            <t> AAA servers may support extensions that allow them to communicate with their clients
              (in our case - the VPN gateway) to push user information. For example, a certain
              product integrates a RADIUS server with the Lightweight Directory Access Protocol 
              (LDAP - <xref target="RFC4511"/>), so a client could query the server using LDAP and 
              receive the real record for this user. Others may provide this data through
              vendor-specific extensions to RADIUS or DIAMETER.</t></list></t>
          <t> In any case authorization is a major issue in deployments, if the backend AAA server
            supporting the re-authentication is different from the AAA server that had supported
            the original authentication. It is up to the re-authenticating AAA server to provide
            the necessary information for authorization. A conforming implementation of this 
            protocol MAY reject initiators for which it is unable to make policy decisions because 
            of these reasons.</t>
        </section>
      </section>
      <section anchor="vid" title="ERX_SUPPORTED Notification">
        <t> The Notify payload is as described in RFC 5996:</t>
        <figure>
            <artwork><![CDATA[
                         1                   2                   3
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    ! Next Payload  !C!  RESERVED   !         Payload Length        !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !  Protocol ID  !   SPI Size    !    ERX Notify Message Type    !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    !                            Domain Name                        !
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
            ]]></artwork>
        </figure>
          <t><list style="symbols">
            <t>Protocol ID (1 octet) MUST be 1, as this message is related to an IKE SA.</t>
            <t>SPI Size (1 octet) MUST be zero, in conformance with section 3.10 of RFC 5996.</t>
            <t>ERX Notify Message Type (2 octets) - MUST be xxxxx, the value assigned for ERX. TBA
              by IANA.</t>
            <t>Domain Name (variable) - contains the domain name or realm, as these terms are used
              in RFC 6696, and encoded as ASCII, as specified in <xref target="RFC4282"/>.</t></list></t>
      </section>
      <section anchor="security" title="Security Considerations">
        <t> The protocol extension described in this document extends the authentication from one
          EAP context, which may or may not be part of IKEv2, to an IKEv2 context. Successful
          completion of the protocol proves to the authenticator, which in our case is a VPN
          gateway, that the supplicant, or VPN client, has authenticated in some other EAP context.</t>
        <t> The protocol supplies the authenticator with the domain name with which the supplicant
          has authenticated, but does not supply it with a specific identity. Instead, the gateway
          receives an EMSKName, which is an ephemeral ID. With this variant of the IKEv2 protocol, 
          the initiator never sends its real identity on the wire, while the server does. This is
          different from the usual IKEv2 practice of the initiator revealing its identity first.</t>
        <t> If the domain name is sufficient to make access control decisions, this is enough. If
          not, then the gateway needs to find out either the real name or authorization information
          for that particular user. This may be done using the AAA protocol or by some other 
          federation protocol, which is out of scope for this specification.</t>  
      </section>
      <section anchor="iana" title="IANA Considerations">
        <t> IANA is requested to assign a notify message type from the status types range 
          (16418-40959) of the "IKEv2 Notify Message Types" registry with name "ERX_SUPPORTED".</t>
      </section>
      <section anchor="ack" title="Acknowledgements">
        <t> The authors would like to thank Yaron Sheffer for comments and suggested text that have
          contributed to this document.</t>
      </section>
  </middle>
  <!-- ====================================================================== -->
  <back>
    <references title="Normative References"> 
      <reference anchor='RFC2119'>
        <front>
          <title abbrev='RFC Key Words'>Key words for use in RFCs to Indicate Requirement Levels</title>
          <author initials='S.' surname='Bradner' fullname='Scott Bradner'>
            <organization>Harvard University</organization>
            <address>
              <postal>
                <street>1350 Mass. Ave.</street>
                <street>Cambridge</street>
                <street>MA 02138</street>
              </postal>
              <phone>- +1 617 495 3864</phone>
              <email>sob@harvard.edu</email>
            </address>
          </author>
          <date year='1997' month='March' />
          <area>General</area>
          <keyword>keyword</keyword>
        </front>
        <seriesInfo name='BCP' value='14' />
        <seriesInfo name='RFC' value='2119' />
        <format type='TXT' octets='4723' target='ftp://ftp.isi.edu/in-notes/rfc2119.txt' />
        <format type='HTML' octets='16553' target='http://tools.ietf.org/html/rfc2119' />
      </reference>
      <reference anchor='RFC5996'>
        <front>
          <title>Internet Key Exchange Protocol: IKEv2</title>
          <author initials='C' surname='Kaufman' fullname='Charlie Kaufman'>
            <organization>Microsoft</organization>
          </author>
          <author initials='P' surname='Hoffman' fullname='Paul Hoffman'>
            <organization>VPN Consortium</organization>
          </author>
          <author initials='Y' surname='Nir' fullname='Yoav Nir'>
            <organization>Check Point</organization>
          </author>
          <author initials='P' surname='Eronen' fullname='Pasi Eronen'>
            <organization>Nokia</organization>
          </author>
          <date month='September' year='2010' />
        </front>
        <seriesInfo name='RFC' value='5996' />
        <format type='TXT' target='http://www.ietf.org/rfc/rfc5996.txt' />
        <format type='HTML' target='http://xml.resource.org/public/rfc/html/rfc5996.html' />
        <format type='XML' target='http://xml.resource.org/public/rfc/xml/rfc5996.xml' />
      </reference>
      <reference anchor='RFC6696'>
        <front>
          <title>EAP Extensions for the EAP Re-authentication Protocol (ERP)</title>
          <author initials='Z.' surname='Cao' fullname='Z. Cao'><organization /></author>
          <author initials='B.' surname='He' fullname='B. He'><organization /></author>
          <author initials='Y.' surname='Shi' fullname='Y. Shi'><organization /></author>
          <author initials='Q.' surname='Wu' fullname='Q. Wu'><organization /></author>
          <author initials='G.' surname='Zorn' fullname='G. Zorn'><organization /></author>
          <date year='2012' month='July' />
        </front>
        <seriesInfo name='RFC' value='6696' />
        <format type='TXT' octets='103860' target='http://www.rfc-editor.org/rfc/rfc6696.txt' />
      </reference>
      <reference anchor='RFC5295'>
        <front>
          <title>Specification for the Derivation of Root Keys from an Extended Master Session Key (EMSK)</title>
          <author initials='J.' surname='Salowey' fullname='J. Salowey'><organization /></author>
          <author initials='L.' surname='Dondeti' fullname='L. Dondeti'><organization /></author>
          <author initials='V.' surname='Narayanan' fullname='V. Narayanan'><organization /></author>
          <author initials='M.' surname='Nakhjiri' fullname='M. Nakhjiri'><organization /></author>
          <date year='2008' month='August' />
        </front>
        <seriesInfo name='RFC' value='5295' />
        <format type='TXT' octets='45622' target='http://www.rfc-editor.org/rfc/rfc5295.txt' />
      </reference>
      <reference anchor='RFC4282'>
        <front>
          <title>The Network Access Identifier</title>
          <author initials='B.' surname='Aboba' fullname='B. Aboba'><organization /></author>
          <author initials='M.' surname='Beadles' fullname='M. Beadles'><organization /></author>
          <author initials='J.' surname='Arkko' fullname='J. Arkko'><organization /></author>
          <author initials='P.' surname='Eronen' fullname='P. Eronen'><organization /></author>
          <date year='2005' month='December' />
        </front>
        <seriesInfo name='RFC' value='4282' />
        <format type='TXT' octets='34421' target='http://www.rfc-editor.org/rfc/rfc4282.txt' />
      </reference>
    </references>
    <references title="Informative References"> 
      <reference anchor='SecureBeacon'>
        <front>
          <title>Secure Beacon: Securely Detecting a Trusted Network</title>
          <author initials='Y.' surname='Sheffer' fullname='Yaron Sheffer'>
            <organization>Check Point</organization></author>
          <author initials='Y.' surname='Nir' fullname='Yoav Nir'>
            <organization>Check Point</organization></author>
          <date year='2009' month='June' />
        </front>
        <seriesInfo name='Internet-Draft' value='draft-sheffer-ipsecme-secure-beacon' />
        <format type='TXT'
          target='http://tools.ietf.org/id/draft-sheffer-ipsecme-secure-beacon' />
        <format type='HTML'
          target='http://tools.ietf.org/html/draft-sheffer-ipsecme-secure-beacon' />
       </reference>
       <reference anchor='RFC2865'>
         <front>
           <title>Remote Authentication Dial In User Service (RADIUS)</title>
           <author initials='C.' surname='Rigney' fullname='C. Rigney'><organization /></author>
           <author initials='S.' surname='Willens' fullname='S. Willens'><organization /></author>
           <author initials='A.' surname='Rubens' fullname='A. Rubens'><organization /></author>
           <author initials='W.' surname='Simpson' fullname='W. Simpson'><organization /></author>
           <date year='2000' month='June' />
         </front>
         <seriesInfo name='RFC' value='2865' />
         <format type='TXT' octets='146456' target='http://www.rfc-editor.org/rfc/rfc2865.txt' />
       </reference>
       <reference anchor='RFC3588'>
         <front>
           <title>Diameter Base Protocol</title>
           <author initials='P.' surname='Calhoun' fullname='P. Calhoun'><organization /></author>
           <author initials='J.' surname='Loughney' fullname='J. Loughney'><organization /></author>
           <author initials='E.' surname='Guttman' fullname='E. Guttman'><organization /></author>
           <author initials='G.' surname='Zorn' fullname='G. Zorn'><organization /></author>
           <author initials='J.' surname='Arkko' fullname='J. Arkko'><organization /></author>
           <date year='2003' month='September' />
         </front>
         <seriesInfo name='RFC' value='3588' />
         <format type='TXT' octets='341261' target='http://www.rfc-editor.org/rfc/rfc3588.txt' />
       </reference>
       <reference anchor='RFC4511'>
         <front>
           <title>Lightweight Directory Access Protocol (LDAP): The Protocol</title>
           <author initials='J.' surname='Sermersheim' fullname='J. Sermersheim'><organization /></author>
           <date year='2006' month='June' />
         </front>
         <seriesInfo name='RFC' value='4511' />
         <format type='TXT' octets='150116' target='http://www.rfc-editor.org/rfc/rfc4511.txt' />
       </reference>
    </references>
    <!-- ====================================================================== -->
  </back>
</rfc>
