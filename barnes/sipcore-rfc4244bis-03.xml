<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY rfc3261 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3261.xml">
<!ENTITY rfc3326 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3326.xml">
<!ENTITY rfc3323 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3323.xml">
<!ENTITY rfc2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY rfc5246 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5246.xml">
<!ENTITY rfc3665 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3665.xml">
<!ENTITY rfc5627 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5627.xml">
<!ENTITY rfc5630 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5630.xml">
<!ENTITY I-D.rosenberg-sip-target-uri-delivery SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.rosenberg-sip-target-uri-delivery.xml">
<!ENTITY rfc3087 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3087.xml">
<!ENTITY rfc4240 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4240.xml">
<!ENTITY rfc5039 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5039.xml">
<!ENTITY rfc4244 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4244.xml">
<!ENTITY rfc4458 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4458.xml">
<!ENTITY rfc3761 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3761.xml">
<!ENTITY rfc4769 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4769.xml">
<!ENTITY I-D.ietf-enum-cnam SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-enum-cnam.xml">
]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc toc="yes" ?>
<?rfc symrefs="yes" ?>
<?rfc iprnotified="no" ?>
<?rfc strict="no" ?>
<?rfc compact="yes" ?>
<?rfc subcompact="no"?>
<?rfc sortrefs="no" ?>
<rfc category="std" docName="draft-barnes-sipcore-rfc4244bis-03.txt"
     ipr="pre5378Trust200902" obsoletes="RFC4244">
  <front>
    <title abbrev="History-Info ">An Extension to the Session Initiation
    Protocol (SIP) for Request History Information</title>

    <author fullname="Mary Barnes" initials="M." surname="Barnes">
      <organization>Nortel</organization>

      <address>
        <postal>
          <street></street>

          <country>US</country>

          <city>Richardson</city>

          <region>TX</region>

          <code></code>

          <country>US</country>
        </postal>

        <email>mary.barnes@nortel.com</email>
      </address>
    </author>

    <author fullname="Francois Audet" initials="F." surname="Audet">
      <organization>Skype Labs</organization>

      <address>
        <postal>
          <street></street>

          <city></city>

          <region></region>

          <code></code>

          <country></country>
        </postal>

        <email>francois.audet@skypelabs.com</email>
      </address>
    </author>

    <author fullname="Shida Schubert" initials="S.S." surname="Schubert">
      <organization>NTT</organization>

      <address>
        <postal>
          <street></street>

          <city></city>

          <region></region>

          <country></country>
        </postal>

        <email>shida@ntt.com</email>
      </address>
    </author>

    <author fullname="Hans Erik van Elburg" initials="J.F.J." surname="van Elburg">
      <organization>Detecon International Gmbh</organization>

      <address>
        <postal>
          <street>Oberkasseler str. 2</street>

          <city>Bonn</city>

          <region></region>
		  <code>53227</code>

          <country>Germany</country>
        </postal>

        <email>ietf.hanserik@gmail.com</email>
      </address>
    </author>

    <author fullname="Christer Holmberg" initials="C.H." surname="Holmberg">
      <organization>Ericsson</organization>

      <address>
        <postal>
          <street></street>

          <city>Hirsalantie 11</city>

          <region>Jorvas</region>

          <country>Finland</country>
        </postal>

        <email>christer.holmberg@ericsson.com</email>
      </address>
    </author>

    <date day="26" month="October" year="2009" />

    <abstract>
      <t>This document defines a standard mechanism for capturing the history
      information associated with a Session Initiation Protocol (SIP) request.
      This capability enables many enhanced services by providing the
      information as to how and why a call arrives at a specific application
      or user. This document defines an optional SIP header, History-Info, for
      capturing the history information in requests.</t>
    </abstract>
  </front>

  <middle>
    <section anchor="intro" title="Introduction">
      <t>Many services that SIP is anticipated to support require the ability
      to determine why and how the call arrived at a specific application.
      Examples of such services include (but are not limited to) sessions
      initiated to call centers via "click to talk" SIP Uniform Resource
      Locators (URLs) on a web page, "call history/logging" style services
      within intelligent "call management" software for SIP User Agents (UAs),
      and calls to voicemail servers. Although SIP implicitly provides the
      redirect/retarget capabilities that enable calls to be routed to chosen
      applications, there is a need for a standard mechanism within SIP for
      communicating the retargeting history of such a request. This "request
      history" information allows the receiving application to determine hints
      about how and why the call arrived at the application/user.</t>

      <t>This document defines a SIP header, History-Info, to provide a
      standard mechanism for capturing the request history information to
      enable a wide variety of services for networks and end-users. The
      History-Info header provides a building block for development of new
      services.</t>

      <t>The requirements for this document are described in <xref
      target="requirements"></xref>.</t>
    </section>

    <section title="Conventions and Terminology">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
      document are to be interpreted as described in <xref
      target="RFC2119"></xref>.</t>

      <t>The term "retarget" is used in this document to refer both to the
      process of a Proxy Server/User Agent Client (UAC) changing a Uniform
      Resource Identifier (URI) in a request based on the rules for
      determining request targets as described in Section 16.5 of <xref
      target="RFC3261"></xref> and the subsequent forwarding of that request
      as described in section 16.6 of <xref target="RFC3261"></xref>.</t>

      <t>The term "forward" is used consistent with the terminology in <xref
      target="RFC3261"></xref>. Noting that <xref target="RFC3261"></xref>
      uses the term "forwarding" to describe a proxy's handling of requests
      for domains for which is not responsible, as well as to describe the
      basic "forwarding" of a request (in section 16.6) once a target has been
      determined. However, the context of the usage is sufficient to
      differentiate the slightly different meanings.</t>

      <t>The terms "location service" and "redirect" are used consistent with
      the terminology in <xref target="RFC3261"></xref>.</t>
    </section>

    <section anchor="overview" title="Overview of Operations">
      <t>SIP implicitly provides retargeting capabilities that enable calls to
      be routed to specific applications as defined in <xref
      target="RFC3261"></xref>. The motivation for capturing the request
      history is that in the process of retargeting a request, old routing
      information can be forever lost. This lost information may be important
      history that allows elements to which the call is retargeted to process
      the call in a locally defined, application-specific manner. This
      document defines a mechanism for transporting the request history.
      Application-specific behavior is outside the scope of this
      specification.</t>

      <t>Current network applications provide the ability for elements
      involved with the call to exchange additional information relating to
      how and why the call was routed to a particular destination. The
      following are examples of such applications:</t>

      <t><list style="numbers">
          <t>Web "referral" applications, whereby an application residing
          within a web server determines that a visitor to a website has
          arrived at the site via an "associate" site that will receive some
          "referral" commission for generating this traffic</t>

          <t>Email forwarding whereby the forwarded-to user obtains a
          "history" of who sent the email to whom and at what time</t>

          <t>Traditional telephony services such as voicemail, call-center
          "automatic call distribution", and "follow-me" style services</t>
        </list></t>

      <t>Several of the aforementioned applications currently define
      application-specific mechanisms through which it is possible to obtain
      the necessary history information.</t>

      <t>In addition, request history information could be used to enhance
      basic SIP functionality by providing the following: <list
          style="symbols">
          <t>Some diagnostic information for debugging SIP requests. (Note
          that the diagnostic utility of this mechanism is limited by the fact
          that its use by entities that retarget is optional.)</t>

          <t>Capturing aliases and Globally Routable User Agent URIs (GRUUs)
          <xref target="RFC5627"></xref>, which can be overwritten by a home
          proxy upon receipt of the initial request.</t>

          <t>Facilitating the use of limited use addresses (minted on demand)
          and sub-addressing.</t>

          <t>Preserving service specific URIs that can be overwritten by a
          downstream proxy, such as those defined in <xref
          target="RFC3087"></xref>, and control of network announcements and
          IVR with SIP URI <xref target="RFC4240"></xref>.</t>

          <t>A stronger security solution for SIP. A side effect is that each
          proxy that captures the "request history" information in a secure
          manner provides an additional means (without requiring signed keys)
          for the original requestor to be assured that the request was
          properly retargeted.</t>
        </list></t>

      <t>The fundamental functionality provided by the request history
      information is the ability to inform proxies and UAs involved in
      processing a request about the history or progress of that request
      (CAPABILITY-req, see <xref target="requirements"></xref>). The solution
      is to capture the Request-URIs as a request is retargeted, in a new
      header for SIP messages: History-Info (CONTENT-req, see <xref
      target="requirements"></xref>). This allows for the capturing of the
      history of a request that would be lost with the normal SIP processing
      involved in the subsequent retargeting of the request. This solution
      proposes no changes in the fundamental determination of request targets
      or in the request forwarding as defined in Sections 16.5 and 16.6 of the
      SIP protocol specification <xref target="RFC3261"></xref>.</t>

      <t>The History-Info header can appear in any request not associated with
      an established dialog (e.g., INVITE, REGISTER, MESSAGE, REFER and
      OPTIONS, PUBLISH and SUBSCRIBE, etc.) (REQUEST-VALIDITY-req, see<xref
      target="requirements"></xref>) and any valid response to these requests
      (ISSUER-req, see<xref target="requirements"></xref>).</t>

      <t>This specification defines parameters (see <xref
      target="definition"></xref>) for carrying the following information in
      the History-Info header:</t>

      <t><list style="symbols">
          <t>Targeted-to-URI: The targeted-to-URI entry captures the
          Request-URI for the specific Request as it is forwarded.</t>

          <t>Index: The index reflects the chronological order of the
          information, indexed to also reflect the forking and nesting of
          requests.</t>

          <t>Reason: Reason describes why an entry was retargeted.</t>

          <t>Privacy: Privacy is used to request that entries be
          anonymized.</t>

          <t>Target: The target parameter indicates the mechanism by which the
          new target is determined, i.e., a "registered contact", or a "mapped
          URI"</t>
        </list></t>

      <t>The following is an illustrative example of usage of
      History-Info.</t>

      <t>In this example, Alice (sip:alice@atlanta.example.com) calls Bob
      (sip:bob@biloxi.example.com). Alice's home proxy
      (sip:atlanta.example.com) forwards the request to Bob's proxy
      (sip:biloxi.example.com). When the request arrives at
      sip:biloxi.example.com, it does a location service lookup for
      bob@biloxi.example.com and changes the target of the request to Bob's
      Contact URIs provided as part of normal SIP registration. In this
      example, Bob is simultaneously contacted on a PC client and on a phone,
      and Bob answers on the PC client.</t>

      <t>One important thing illustrated by this call flow is that without
      History-Info, Bob would "lose" the target information, including any
      parameters in the request URI. Bob can now recover that information by
      looking for the prior entry to the last hi-entry marked as "rc"</t>

      <t>The formatting in this scenario is for visual purposes; thus,
      backslash and CRLF are used between the fields for readability and the
      headers in the URI are not shown properly formatted for escaping. Refer
      to <xref target="example"></xref> for the proper formatting. Additional
      detailed scenarios are available in the <xref
      target="appendix"></xref>.</t>

      <t><list style="empty">
          <t>Note: This example uses loose routing procedures.</t>
        </list></t>

      <figure anchor="basicFlow" title="Basic Call">
        <artwork><![CDATA[
Alice   atlanta.example.com  biloxi.example.com   Bob@pc  Bob@phone
|                |                |                |          |
|   INVITE sip:bob@biloxi.example.com;p=x          |          |
|--------------->|                |                |          |
| Supported: histinfo             |                |          |
|                |                |                |          |
|                |   INVITE sip:bob@biloxi.example.com;p=x
|                |--------------->|                |          |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
|                |                |                |          |
|                |                |   INVITE sip:bob@192.0.2.3
|                |                |--------------->|          |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3>;index=1.1.1;rc  
|                |                |                |          |
|                |                |     INVITE sip:bob@192.0.2.7
|                |                |-------------------------->|
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.7>;index=1.1.2;rc  
|                |                |     200        |          |
|                |                |<---------------|          |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3>;index=1.1.1;rc
|                |                |                |          |
|                |                |<===Proxy cancels INVITE==>|
|                |     200        |                |          |
|                |<---------------|                |          |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3>;index=1.1.1;rc
| History-Info: <sip:bob@192.0.2.7?Reason=SIP;cause=487>;\
|               index=1.1.2;rc
|                |                |                |          |
|     200        |                |                |          |         
|<---------------|                |                |          |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3;index=1.1.1;rc
| History-Info: <sip:bob@192.0.2.7?Reason=SIP;cause=487>;\
|               index=1.1.2;rc
|                |                |                |          |
|     ACK        |                |                |          |
|--------------->|    ACK         |                |          |
|                |--------------->|     ACK        |          |
|                |                |--------------->|          |

]]></artwork>
      </figure>
    </section>

    <section anchor="ua" title="General User Agent Behavior">
      <t>This section describes the processing specific to UAs for the
      History-Info header.</t>

      <section anchor="uac" title="User Agent Client (UAC) Behavior">
        <t>The UAC SHOULD include the "histinfo" option tag in the Supported
        header in any request not associated with an established dialog for
        which the UAC would like the History-Info header in the response. In
        addition, the UAC MAY add a History-Info header, using the Request-URI
        of the request as the hi-target-to-uri, in which case the index MUST
        be set to a value of 1 in the hi-entry. As a result, intermediaries
        and the UAS will know at least the original Request-URI, and if the
        Request-URI was modified by a previous hop. Normally, UACs are not
        expected to include a History-Info header in an initial request as it
        is more of a Proxy function; the main reason it is allowed is for
        B2BUAs who are performing proxy-like functions like routing.</t>

        <t>A UAC that does not want an hi-entry added due to privacy
        considerations MUST include a Privacy header with a priv-value(s) of
        "header" or "history." A UAC that wants to ensure that privacy not be
        applied to its identity MUST include a Privacy header with a
        priv-value of "none."</t>

        <t>In the case where a UAC receives a 3xx response with a Contact
        header and sends a new request in response to it, the UAC MUST include
        in the outgoing request the previous hi-entry(s) received in the
        response. The UAC MUST evaluate the last hi-entry in the 3xx response
        and verify that they are the same (as per the procedures in section
        <xref target="redirect"></xref>); if the hi-entry is not the same as
        the value in contact, hi-entry MUST be added using the value of
        Contact.</t>

        <t>If the hi-entry for the redirection is not included in the 3xx
        response, then an hi-entry MUST be added to the outgoing request. In
        this case, the index MUST be created by reading and incrementing the
        value of the index from the previous hi-entry, thus following the same
        rules as those prescribed for a proxy in retargeting, described in
        <xref target="indexhi"></xref>. The reason MUST be added per <xref
        target="reasonhi"></xref>. The hi-target and hi-aor attributes MUST
        NOT be added to this hi-entry since there is no way to know the
        mechanism by which the redirecting entity determined the URI in the
        Contact header nor whether the previous hi-targeted-to-uri was an
        AOR.</t>

        <t>If no hi-entry for redirection were included at all in the 3xx
        response, and multiple redirection occurs, the UAC MAY attempt to
        synthetise the missing hi-entrie(s) before inserting the last one (as
        per the previous step). At a minimum, the last entry (as per the
        previous step) MUST be included.</t>

        <t>With the exception of the processing of a 3xx response described
        above, the processing of the History-Info header received in the
        Response is application specific and outside the scope of this
        document.</t>
      </section>

      <section anchor="uas" title="User Agent Server (UAS) Behavior">
        <t>Once the request terminates at the UAS, the processing of the
        information in the History-Info header by a UAS in a Request depends
        upon local policy and specific applications at the UAS that might make
        use of the information. Prior to any application usage of the
        information, the validity SHOULD be ascertained. For example, the
        entries MAY be evaluated to determine gaps in indices, which could
        indicate that an entry has been maliciously removed or removed for
        privacy reasons. Either way, an application MAY want to be aware of
        potentially missing information.</t>

        <t>If the "histinfo" option tag is received in a request, the UAS MUST
        include any History-Info received in the request in the subsequent
        response. If privacy is required, entries MUST be anonymized using
        <xref target="RFC3323"></xref>. The UAS MUST follow the rules for a
        redirect server per <xref target="redirect"></xref> in generating a
        3xx response.</t>

        <t>The processing of History-Info in responses follows the methodology
        described in Section 16.7 of <xref target="RFC3261"></xref>, with the
        processing of History-Info headers adding an additional step, just
        before Step 9, "Forwarding the Response".</t>

        <section anchor="redirect" title="Redirect Server Behavior">
          <t>A redirect server MUST include the History-Info headers received
          in the request in the 3XX response that it sends, and it MUST
          perform the following steps:</t>

          <t><list style="hanging">
              <t hangText="Step 1:">Adding Entries on Behalf of Previous
              Hops</t>

              <t hangText="">If an incoming request does not already have a
              History-Info header field (e.g., the UAC does not include any
              History-Info header and no proxies in between support
              History-Info), or if the Request-URI of the incoming request
              does not match the last hi-entry (e.g., the last hop proxy does
              not support History-Info), the redirect server MUST insert an
              hi-entry. The redirect server MUST set the hi-targeted-to-uri to
              the value of Request URI in the incoming request, unless privacy
              is required. If privacy is required, the procedures of <xref
              target="privacyhi"></xref> MUST be used. The proxy MUST NOT
              include a hi-target attribute. The proxy MUST include an
              hi-index attribute as described in <xref
              target="indexhi"></xref>.</t>

              <t hangText="Step 2:">Tagging the Last Incoming Entry</t>

              <t hangText="">The redirect server then examines the last
              hi-entry of the History-Info header resulting from the previous
              step. If privacy is required for this entry, the procedures of
              <xref target="privacyhi"></xref> MUST be used for that entry.
              The Reason header MUST be added to that entry as per the
              procedures of <xref target="reasonhi"></xref>, and must be set
              to the proper SIP 3XX response.</t>

              <t hangText="Step 3:">Generating New Entries for the
              Response</t>

              <t hangText="">The redirect servert MUST add a new hi-entry for
              each of the Contact header URIs, which becomes the new
              Request-URIs when the recipient forwards the new Request. The
              index is created as described in <xref target="indexhi"></xref>.
              If privacy is required, the procedures of <xref
              target="privacyhi"></xref> MUST be used. A hi-target parameter
              MUST be included if the new Request-URI either represents
              another user or registered contact as per the procedures of
              <xref target="addtarget"></xref>.</t>
            </list></t>

          <t>Redirection is an iterative process, i.e., a redirect server may
          redirect "internally " more than one time. A typical example would
          be a redirect server that redirects a request first to a different
          user (i.e., it maps to a different AOR), and then redirects again to
          a registered contact bound to that new AOR. A redirect server that
          uses such mechamism SHOULD add multiple hi-entry fields to provide a
          logical description of retargeting process (e.g., bob@example.com to
          office@example.com to office@192.0.2.5). A Reason MAY be associated
          with the hi-targeted-to-uri that has been retargeted. See the
          example in<xref target="fork"></xref>) for an example.</t>
        </section>
      </section>
    </section>

    <section anchor="proxy" title="Proxy Behavior">
      <t>The specific processing by proxies for adding the History-Info
      headers in Requests and Responses is described in this section for the
      following cases:</t>

      <t><list style="symbols">
          <t>Forwarding of initial request (see <xref
          target="initreq"></xref>)</t>

          <t>Resending based on failure response (see <xref
          target="failure"></xref>)</t>

          <t>Resending based on redirection response (see <xref
          target="redirection"></xref>)</t>
        </list></t>

      <section anchor="addhi"
               title="Adding the History-Info Header to Requests ">
        <t>This section describes the process of adding the History-Info
        Header to Requests.</t>

        <t>Retargeting is an iterative process, i.e., a proxy may redirect
        "internally " more than one time. A typical example would be a proxy
        that redirects a request first to a different user (i.e., it maps to a
        different AOR), and then forwards to a registered contact bound to
        that new AOR. A proxy that uses such mechamism SHOULD add multiple
        hi-entry fields to provide a logical description of the retargeting
        process.</t>

        <section anchor="initreq" title="Initial Request">
          <t>Upon receipt of an initial request for a dialog, or a standalone
          request, a proxy forwarding the request MUST perform the following
          steps. Note that those steps below do not apply if the request is
          being re-sent as a result of failure (i.e., timeout, reception of an
          error response), or redirection caused by receipt of a 3XX
          message).</t>

          <t><list style="hanging">
              <t hangText="Step 1:">Adding Entries on Behalf of Previous
              Hops</t>

              <t hangText="">If an incoming request does not already have a
              History-Info header field (e.g., the UAC does not include any
              History-Info header and no proxies in between support
              History-Info), or if the Request-URI of the incoming request
              does not match the last hi-entry (e.g., the last proxy does not
              support History-Info), the proxy MUST insert an hi-entry. The
              proxy MUST set the hi-targeted-to-uri based to the value of
              Request URI in the incoming request, unless privacy is required.
              If privacy is required, the procedures of <xref
              target="privacyhi"></xref> MUST be used. The proxy MUST NOT
              include a hi-target attribute. The proxy MUST include an
              hi-index attribute as described in <xref
              target="indexhi"></xref>.</t>

              <t hangText="Step 2:">Generating New Entries for Each Outgoing
              Requests</t>

              <t hangText="">The proxy then proceeds to determining the
              request targets as per 16.5/<xref target="RFC3261"></xref> and
              request forwarding as per 16.6/<xref target="RFC3261"></xref>.
              The proxy MUST add a separate hi-entry in each separate outgoing
              request for each of the current (outgoing) targets in the target
              set. The proxy MUST set the hi-targeted-to-uri in those separate
              hi-entry(s) to the value of the Request-URI of the current
              (outgoing) request, unless privacy is required. If privacy is
              required, the procedures of <xref target="privacyhi"></xref>
              MUST be used. The proxy MUST include a hi-target attribute for
              each of the separate entry(s) as described in <xref
              target="addtarget"></xref>. The proxy MUST include an hi-index
              for each of the separate hi-entry(s) as described in <xref
              target="indexhi"></xref>.</t>
            </list></t>
        </section>

        <section anchor="failure" title="Re-sending based on failure response">
          <t>When re-sending a request as a result of retargeting because of
          failure (i.e., either reception of error responses or a timeout
          which is considered to be an implicit 487 error response), the proxy
          MUST perform the following steps:</t>

          <t><list style="hanging">
              <t hangText="Step 1:">Including the Entries from Error Responses
              &amp; Timeouts</t>

              <t hangText="">The proxy MUST build the History-Info header
              field(s) sent in the outgoing request using the aggregate
              information associated with the received error responses(s) and
              timeout(s) for all the branches that are generating failures,
              including the header entries in the order indicated by the
              indexing (see <xref target="indexhi"></xref>). If the received
              error response did not include any History-Info header fields,
              the proxy MUST use the same History-Info header fields that were
              sent in the outgoing request that failed to build the outgoing
              request.</t>

              <t hangText="Step 2:">Tagging the Last Entries</t>

              <t hangText="">The proxy then examines the last hi-entry of the
              History-Info that was just generated in Step 1 for each one of
              the branches that generated failures or timeouts and MUST add a
              Reason header for each one of those entries as per the
              procedures of <xref target="reasonhi"></xref>.</t>

              <t hangText="Step 3:">Generating New Entries for Each Outgoing
              Requests</t>

              <t hangText="">Same as per Step 3 above for the normal
              forwarding case.</t>
            </list></t>
        </section>

        <section anchor="redirection"
                 title="Re-sending based on redirection response  ">
          <t>When re-sending a request as a result of retargeting because of
          redirection (i.e., receipt of a 3XX response), the following steps
          apply:</t>

          <t><list style="hanging">
              <t hangText="Step 1:">Including Previous Entries</t>

              <t hangText="">If the received 3XX response does not include any
              History-Info header fields, the proxy MUST include the
              History-Info header fields that were sent in the outgoing
              request that is being redirected. The proxy MUST then perform
              Steps 2 and 3.</t>

              <t hangText="">If the 3XX response contains a History-Info
              Header field, but the last entries does not correspond to the
              current target (i.e., they do not correspond to the Contact(s)
              in the 3XX), the proxy MUST include in the outgoing request the
              same History-Info header fields that were received in the 3XX
              response. The proxy MUST then perform Steps 2 and 3.</t>

              <t hangText="">If the 3XX response contains a History-Info
              Header field and the last entries correspond to the current
              target (i.e., they correspond to the Contact(s) in the 3XX), the
              proxy MUST include in the outgoing request the same History-Info
              header fields that were received in the 3XX response. No other
              entries need to be added as this is the complete set: the proxy
              MUST NOT perform Steps 2 and 3.</t>

              <t hangText="Step 2:">Tagging the Last Entry</t>

              <t hangText="">The proxy then examines the last hi-entry of the
              History-Info that was just generated in Step 1 and MUST add a
              Reason header this entry as per the procedures of <xref
              target="reasonhi"></xref>.</t>

              <t hangText="Step 3:">Generating New Entries for Each Outgoing
              Requests</t>

              <t hangText="">Same as per Step 3 above for the normal
              forwarding case, except that the hi-target parameter MUST NOT be
              set when the proxy receiving the 3xx does not know the mechanism
              by which this target was determined. For example, the proxy can
              not determine the hi-target mechanism when the domain of the
              Contact is not under the control of the proxy. However, if it
              under the control of the proxy, then it may be able to determine
              the mechanism (e.g., Bob can deflect a call to his SIP PC client
              to his cell phone).</t>
            </list></t>
        </section>
      </section>

      <section anchor="hiresponse" title="Sending History-Info in Responses">
        <t>A proxy that receives a Request with the "histinfo" option tag in
        the Supported header, SHOULD forward captured History-Info in
        subsequent, provisional, and final responses to the Request sent by
        the ultimate UAS (see <xref target="uas"></xref>).</t>

        <t>A proxy MAY anonymize any hi-entry whose domain corresponds to a
        domain for which it is responsible (as per <xref
        target="RFC3323"></xref>). For example, anonymity may be required when
        responses are forwarded to a domain for which it is not
        responsible.</t>

        <t>The processing of History-Info in responses follows the methodology
        described in Section 16.7 of <xref target="RFC3261"></xref>, with the
        processing of History-Info headers adding an additional step, just
        before Step 9, "Forwarding the Response".</t>
      </section>
    </section>

    <section anchor="structure" title="The History-Info header field">
      <section anchor="definition" title="Definition">
        <t>History-Info is a header field as defined by <xref
        target="RFC3261"></xref>. "It may appear in any initial request for a
        dialog, standalone request or responses associated with these
        requests. For example, History-Info may appear in INVITE, REGISTER,
        MESSAGE, REFER, OPTIONS, SUBSCRIBE, and PUBLISH and any valid
        responses, plus NOTIFY requests that initiate a dialog.</t>

        <t>The History-Info header carries the following information, with the
        mandatory parameters required when the header is included in a request
        or response:</t>

        <t><list style="symbols">
            <t>Targeted-to-URI (hi-targeted-to-uri): A mandatory parameter for
            capturing the Request-URI for the specific Request as it is
            forwarded.</t>

            <t>Index (hi-index): A mandatory parameter for History-Info
            reflecting the chronological order of the information, indexed to
            also reflect the forking and nesting of requests. The format for
            this parameter is a string of digits, separated by dots to
            indicate the number of forward hops and retargets. This results in
            a tree representation of the history of the request, with the
            lowest-level index reflecting a branch of the tree. By adding the
            new entries in order (i.e., following existing entries per the
            details in <xref target="addhi"></xref>), including the index and
            securing the header, the ordering of the History-Info headers in
            the request is assured (SEC-req-2, see <xref
            target="secreq"></xref>). In addition, applications may extract a
            variety of metrics (total number of retargets, total number of
            retargets from a specific branch, etc.) based upon the index
            values.</t>

            <t>Reason: An optional parameter for History-Info, reflected in
            the History-Info header by including the Reason Header <xref
            target="RFC3326"></xref> escaped in the hi-targeted-to-uri. A
            reason is included for the hi-targeted-to-uri that was retargeted
            as opposed to the hi-targeted-to-uri to which it was
            retargeted.</t>

            <t>Privacy: An optional parameter for History-Info, reflected in
            the History-Info header field values by including the Privacy
            Header <xref target="RFC3323"></xref> escaped in the hi-
            targeted-to-uri or by adding the Privacy header to the Request.
            The latter case indicates that the History-Info entries for the
            domain MUST be anonymized prior to forwarding, whereas the use of
            the Privacy header escaped in the hi-targeted-to-uri means that a
            specific hi-entry MUST be anonymized.</t>

            <t>Target (hi-target): An optional parameter for the History-Info
            indicating the mechanism by which the new target is determined,
            based on the procedures of 16.5 <xref target="RFC3261"></xref>.
            The hi-target is added for a hi-entry when it is first added in a
            History-Info header field, and only one value is permitted. Upon
            receipt of a request or response containing the History-Info
            header, a UA can determine the nature of the target. The following
            values are defined for this parameter:<list style="symbols">
                <t>"rc": The entry is a contact that is bound to an AOR in an
                abstract location service. The AOR-to-contact binding has been
                placed into the location service by a SIP Registrar that
                received a SIP REGISTER request.</t>

                <t>"mp": The entry is a URI that represents another user. This
                occurs in cases where a request is statically or dynamically
                retargeted to another user. The index entry of the target of
                the original target is added as a parameter to the "mp" (i.e.,
                it represents the "mapped from" target).</t>
              </list></t>

            <t>Extension (hi-extension): A parameter to allow for future
            optional extensions. As per <xref target="RFC3261"></xref>, any
            implementation not understanding an extension should ignore
            it.</t>
          </list></t>

        <t>The following summarizes the syntax of the History-Info header,
        based upon the standard SIP syntax <xref target="RFC3261"></xref>:</t>

        <figure>
          <artwork><![CDATA[
History-Info = "History-Info" HCOLON hi-entry *(COMMA hi-entry)

hi-entry = hi-targeted-to-uri *(SEMI hi-param) 

hi-targeted-to-uri = name-addr

hi-param = hi-index / hi-target / hi-extension

hi-index = "index" EQUAL 1*DIGIT *("." 1*DIGIT)

hi-target = "rc" / mp-param

mp-param = "mp" EQUAL 1*DIGIT *("." 1*DIGIT)

hi-extension = generic-param

]]></artwork>
        </figure>

        <t>The following rules apply:<list style="symbols">
            <t>There MUST exactly 1 hi-index parameter per hi-entry.</t>

            <t>There MUST be no more than 1 hi-target parameter.</t>

            <t>They MAY be any number of hi-extension parameters.</t>

            <t>The ABNF definitions for "generic-param" and "name-addr" are
            from <xref target="RFC3261"></xref>.</t>
          </list></t>
      </section>

      <section anchor="example" title="Examples">
        <t>The following provides some examples of the History-Info header.
        Note that the backslash and CRLF between the fields in the examples
        below are for readability purposes only.</t>

        <figure>
          <artwork><![CDATA[
History-Info: <sip:UserA@ims.example.com>;index=1;foo=bar

History-Info: <sip:UserA@ims.example.com?Reason=SIP%3B\
              cause%3D302>;index=1.1,\
              <sip:UserB@example.com?Privacy=history&Reason=SIP%3B\
              cause%3D486>;index=1.2;mp=1.1,\
              <sip:45432@192.168.0.3>;index=1.3;rc]]></artwork>
        </figure>
      </section>

      <section title="Procedures">
        <t>The following sections defines procedures for different parameters
        in the History-Info header. These procedures may be applicable to
        "processing entities" such as Proxies, Redirect Servers or User
        Agents.</t>

        <section anchor="privacyhi" title="Privacy in the History-Info Header">
          <t>The privacy requirements for this document are described in <xref
          target="privacyreq"></xref>.</t>

          <t>Since the History-Info header can inadvertently reveal
          information about the requestor as described in <xref
          target="RFC3323"></xref>, the Privacy header can be used to
          determine whether an intermediary can include the Request-URI in a
          Request that it receives (PRIV-req-2, see <xref
          target="privacyreq"></xref>) or that it retargets (PRIV-req-1, see
          <xref target="privacyreq"></xref>) as an entry in a History-Info
          header. Thus, the History- Info entry for that identity can be
          anonymized where the requestor has indicated a priv-value of
          Session- or Header-level privacy.</t>

          <t>Privacy is associated with a specific history information entry,
          and perhaps any entry that corresponds to that same user, and not
          the History-Info header itself. This allows for anonymizing some
          entries, but not others, as required. For example, if Alice sends a
          request to Bob without any privacy, and Bob redirects to Carol with
          privacy setup for himself, Carol should receive a request where
          Alice's history information is present, but Bob's has been
          anonymized.</t>

          <t>In addition, the History-Info header can reveal general routing
          information which may be viewed by a specific intermediary or
          network. Thus, a proxy can use local policy to determine whether the
          History-Info header entries for it's whole domain are private or not
          when exiting the domain through retargeting (PRIV-req-3). This is
          accomplished by adding a new priv-value, history, to the Privacy
          header <xref target="RFC3323"></xref> indicating that a specific
          History-Info header entry can not be forwarded outside the
          domain.</t>

          <t>It is recognized that satisfying the privacy requirements can
          impact the functionality of this solution by overriding the request
          to generate the information.</t>

          <t>If there is a Privacy header in the request with a priv-value of
          "session", "header", or "history", an hi-entry SHOULD be added if
          the request is being retargeted to a URI associated with a domain
          for which the processing entity is responsible. If there is no
          Privacy header, but the processing entity's local policies indicate
          that the hi-entry(s) cannot be forwarded beyond the domain for which
          this intermediary is responsible, then a Privacy header with a
          priv-value of "history" SHOULD be associated with each hi-entry
          added by the proxy as the request is forwarded within the
          domain.</t>

          <t>If a request is being retargeted to a URI associated with a
          domain for which the processing identity is not responsible and
          there is a Privacy header in the request with a priv-value of
          "session", "header", or "history", the processing entity MUST
          anonymize hi-entry(s) as per <xref target="RFC3323"></xref> prior to
          forwarding, unless the processing entity knows a priori that it can
          rely on a downstream processing entity within its domain to apply
          the requested privacy or local policy allows the forwarding.</t>
        </section>

        <section anchor="reasonhi" title="Reason in the History-Info Header">
          <t>For retargets that are the result of an explicit SIP response, a
          Reason MUST be associated with the hi-targeted-to-uri. If the SIP
          response does not include a Reason header (see <xref
          target="RFC3326"></xref>), the SIP Response Code that triggered the
          retargeting MUST be included as the Reason associated with the
          hi-targeted-to-uri that has been retargeted. If the response
          contains a Reason header for a protocol that is not SIP (e.g.,
          Q.850), it MUST be captured as an additional Reason associated with
          the hi-targeted-to- uri that has been retargeted, along with the SIP
          Response Code. If the Reason header is a SIP reason, then it MUST be
          used as the Reason associated with the hi-targeted-to-uri rather
          than the SIP response code.</t>

          <t>If a request has timed out (instead of being explicitly
          rejected), it SHOULD be treated as if a 487 "Request Terminated"
          error response code was received.</t>
        </section>

        <section anchor="indexhi" title="Indexing in the History-Info Header">
          <t>In order to maintain ordering and accurately reflect the nesting
          and retargeting of the request, an index MUST be included along with
          the Targeted-to-URI being captured. Per the syntax in <xref
          target="structure"></xref>, the index consists of a dot-delimited
          series of digits (e.g., 1.1.2). Each dot reflects a hop or level of
          nesting; thus, the number of hops is determined by the total number
          of dots. Within each level, the integer reflects the number of peer
          entities to which the request has been routed. Thus, the indexing
          results in a logical tree representation for the history of the
          Request. For each level of indexing, the index MUST start at 1. An
          increment of 1 MUST be used for advancing to a new branch. The first
          entry MUST be set to 1.</t>

          <t>The basic rules for adding the index are summarized as follows:
          <list style="numbers">
              <t>Basic Forwarding: In the case of a Request that is being
              forwarded, the index is determined by adding another sub-level
              of indexing since the depth/length of the branch is increasing.
              To accomplish this, the processing entity reads the value from
              the History-Info header in the received request, if available,
              and adds another level of indexing by appending the dot
              delimiter followed by an initial index for the new level of 1.
              For example, if the index in the last History-Info header field
              in the received request is 1.1, this proxy would initialize its
              index to 1.1.1 and forward the request.</t>

              <t>Retargeting within a processing entity - 1st instance: For
              the first instance of retargeting within a processing entity,
              the calculation of the index follows that prescribed for basic
              forwarding.</t>

              <t>Retargeting within a processing entity - subsequent instance:
              For each subsequent retargeting of a request by the same
              processing entity, another branch is added. With the index for
              each new branch calculated by incrementing the last/lowest digit
              at the current level, the index in the next request forwarded by
              this same processing entity, following the example above, would
              be 1.1.2.</t>

              <t>Retargeting based upon a Response: In the case of retargeting
              due to a specific response (e.g., 302), the index would be
              calculated per rule 3. That is, the lowest/last digit of the
              index is incremented (i.e., a new branch is created), with the
              increment of 1. For example, if the index in the History-Info
              header of the received request was 1.2, then the index in the
              History-Info header field for the new hi-targeted- to-URI would
              be 1.3.</t>

              <t>Forking requests: If the request forwarding is done in
              multiple forks (sequentially or in parallel), the index MUST be
              captured for each forked request per the rules above, with each
              new Request having a unique index. Each index are sequentially
              assigned. For example, if the index in the last History-Info
              header field in the received request is 1.1, this processing
              entity would initialize its index to 1.1.1 for the first fork,
              1.1.2 for the second, and so forth (see <xref
              target="basicFlow"></xref> for an example). Note that for each
              individual fork, only the entry corresponding that that fork is
              included (e.g., the entry for fork 1.1.1 is not included in the
              request sent to fork 1.1.2, and vice-versa).</t>

              <t>When a response is built and it represents the aggregate of
              multiple forks (e.g., multiple forks that fail), the processing
              entity builds the subsequent response using the aggregated
              information associated with each of those forks and including
              the header entries in the order indicated by the indexing. For
              example, if a procesing entity received failure responses for
              forks 1.1.1 and 1.1.2, it would forward both the 1.1.1 and 1.1.2
              entries to 1.1. See <xref target="fork"></xref> for an example.
              Responses are processed as described in Section 16.7 of <xref
              target="RFC3261"></xref> with the aggregated History-Info
              entries processed similar to Step 7 "Aggregate Authentication
              Header Field Values".</t>
            </list></t>
        </section>

        <section anchor="addtarget"
                 title="Request Target in the History-Info Header">
          <t>The value for the hi-target attribute is based upon the mechanism
          by which the new target has been determined per the procedures
          described in 16.5/<xref target="RFC3261"></xref>. The following
          describes how the specific values for the hi-target attribute are
          determined:</t>

          <t><list style="symbols">
              <t>If the Request-URI is a contact that is bound to an AOR in an
              abstract location service for the domain for which the
              processing entity is responsible, and the AOR-to-contact binding
              has been placed into the location service by a SIP Registrar
              that received a REGISTER request, the hi-target attribute MUST
              be added to the hi-entry with a value of "rc."</t>

              <t>If the Request-URI is a URI that represents another user than
              the one indicated by the incoming Request-URI, as this would
              occur in cases where a request is statically or dynamically
              retargeted to another user, the hi-target attribute MUST be
              added to the hi-entry with a value of "mp." The index of the
              entry corresponding to the original target (i.e., the
              "mapped-from" target) MUST be added as a parameter to "mp".</t>
            </list></t>
        </section>
      </section>
    </section>

    <section anchor="application" title="Application Considerations">
      <t>As seen by the example scenarios in the <xref
      target="appendix"></xref>, History-Info provides a very flexible
      building block that can be used by intermediaries and UAs for a variety
      of services. As such, any services making use of History-Info must be
      designed with the following considerations:</t>

      <t><list style="numbers">
          <t>History-Info is optional; thus, a service MUST define default
          behavior for requests and responses not containing History-Info
          headers.</t>

          <t>History-Info may be impacted by privacy considerations.
          Applications requiring History-Info need to be aware that if
          Header-, Session-, or History-level privacy is requested by a UA (or
          imposed by an intermediary) that History-Info may not be available
          in a request or response. This would be addressed by an application
          in the same manner as the previous consideration by ensuring there
          is reasonable default behavior should the information not be
          available.</t>

          <t>History-Info may be impacted by local policy. Each application
          making use of the History-Info header SHOULD address the impacts of
          the local policies on the specific application (e.g., what
          specification of local policy is optimally required for a specific
          application and any potential limitations imposed by local policy
          decisions). Note that this is related to the optionality and privacy
          considerations identified in 1 and 2 above, but goes beyond that.
          For example, due to the optionality and privacy considerations, an
          entity may receive only partial History-Info entries; will this
          suffice? Note that this would be a limitation for debugging
          purposes, but might be perfectly satisfactory for some models
          whereby only the information from a specific intermediary is
          required.</t>
        </list></t>
    </section>

    <section anchor="security" title="Security Considerations">
      <t>The security requirements for this document are specified in <xref
      target="secreq"></xref>.</t>

      <t>This document defines a header for SIP. The use of the Transport
      Layer Security (TLS) protocol <xref target="RFC5246"></xref> as a
      mechanism to ensure the overall confidentiality of the History-Info
      headers (SEC-req-4) is strongly RECOMMENDED. This results in
      History-Info having at least the same level of security as other headers
      in SIP that are inserted by intermediaries. With TLS, History-Info
      headers are no less, nor no more, secure than other SIP headers, which
      generally have even more impact on the subsequent processing of SIP
      sessions than the History-Info header.</t>

      <t>With the level of security provided by TLS (SEC-req-3), the
      information in the History-Info header can thus be evaluated to
      determine if information has been removed by evaluating the indices for
      gaps (SEC-req-1, SEC-req-2). It would be up to the application to define
      whether it can make use of the information in the case of missing
      entries.</t>

      <t>Note that while using the SIPS scheme (as per <xref
      target="RFC5630"></xref>) protects History-Info from tampering by
      arbitrary parties outside the SIP message path, all the intermediaries
      on the path are trusted implicitly. A malicious intermediary could
      arbitrarily delete, rewrite, or modify History-Info. This specification
      does not attempt to prevent or detect attacks by malicious
      intermediaries.</t>
    </section>

    <section anchor="iana" title="IANA Considerations">
      <t>This document requires several IANA registrations detailed in the
      following sections.</t>

      <t>This document updates <xref target="RFC4244"></xref> but uses the
      same SIP header field name and option tag. The IANA registry needs to
      update the references to <xref target="RFC4244"></xref> witht
      [RFCXXXX].</t>

      <section anchor="header"
               title="Registration of New SIP History-Info Header">
        <t>This document defines a SIP header field name: History-Info and an
        option tag: histinfo. The following changes have been made to
        http:///www.iana.org/assignments/sip-parameters The following row has
        been added to the header field section:.</t>

        <t>The following row has been added to the header field section:</t>

        <figure>
          <artwork><![CDATA[
Header Name             Compact Form               Reference
-----------             ------------               ---------
History-Info               none                    [RFCXXXX]

]]></artwork>
        </figure>

        <t>The following has been added to the Options Tags section:</t>

        <figure>
          <artwork><![CDATA[
Name          Description                          Reference
----          -----------                          ---------
histinfo      When used with the Supported header, [RFCXXXX]
              this option tag indicates the UAC
              supports the History Information to be
              captured for requests and returned in
              subsequent responses.  This tag is not
              used in a Proxy-Require or Require
              header field since support of
              History-Info is optional.

]]></artwork>
        </figure>

        <t>Note to RFC Editor: Please replace RFC XXXX with the RFC number of
        this specification.</t>
      </section>

      <section title="Registration of &quot;history&quot; for SIP Privacy Header">
        <t>This document defines a priv-value for the SIP Privacy header:
        history The following changes have been made to
        http://www.iana.org/assignments/sip-priv-values The following has been
        added to the registration for the SIP Privacy header:</t>

        <figure>
          <artwork><![CDATA[
Name      Description               Registrant   Reference
----      -----------               ----------   ---------
history   Privacy requested for     Mary Barnes  [RFCXXXX]
          History-Info header(s)    mary.barnes@nortel.com

]]></artwork>
        </figure>

        <t>Note to RFC Editor: Please replace RFC XXXX with the RFC number of
        this specification.</t>
      </section>
    </section>

    <section title="Contributors">
      <t>Cullen Jennings, Mark Watson, and Jon Peterson contributed to the
      development of the initial requirements for <xref
      target="RFC4244"></xref>.</t>

      <t>Jonathan Rosenberg, Christer Holmberg, Hans Erik van Elburg and Shida
      Schubert produced the document that provided much of the content for
      this specification.</t>
    </section>

    <section title="Acknowledgements">
      <t>The editor would like to acknowledge the constructive feedback
      provided by Robert Sparks, Paul Kyzivat, Scott Orton, John Elwell, Nir
      Chen, Palash Jain, Brian Stucker, Norma Ng, Anthony Brown, Jayshree
      Bharatia, Jonathan Rosenberg, Eric Burger, Martin Dolly, Roland Jesske,
      Takuya Sawada, Sebastien Prouvost, and Sebastien Garcin in the
      development of <xref target="RFC4244"></xref>. The editor would like to
      acknowledge the significant input from Rohan Mahy on some of the
      normative aspects of the ABNF for <xref target="RFC4244"></xref>,
      particularly around the need for and format of the index and around the
      security aspects.</t>

      <t>Thanks to Ian Elz for his feedback on privacy.</t>
    </section>

    <section title="Changes from RFC 4244">
      <t>This RFC replaces <xref target="RFC4244"></xref>.</t>

      <t>Deployment experience with <xref target="RFC4244"></xref> over the
      years has shown a number of issues, warranting an update:</t>

      <t><list style="symbols">
          <t>In order to make <xref target="RFC4244"></xref> work in "real
          life", one needs to make "assumptions" on how History-Info is used.
          For example, many implementations filter out many entries, and only
          leave specific entries corresponding, for example, to first and last
          redirection. Since vendors uses different rules, it causes
          significant interoperability isssues.</t>

          <t><xref target="RFC4244"></xref> is overly permissive and evasive
          about recording entries, causing interoperability issues.</t>

          <t>The examples in the call flows had errors, and confusing because
          they often assume "loose routing."</t>

          <t><xref target="RFC4244"></xref> has lots of repetitive and unclear
          text</t>

          <t><xref target="RFC4244"></xref> gratuitly mandates the use of TLS
          on every hop. No existing implementation enforces this rule, and
          instead, the use of TLS or not is a general SIP issue, not an <xref
          target="RFC4244"></xref> issue per se.</t>

          <t><xref target="RFC4244"></xref> does not include clear procedures
          on how to deliver current target URI information to the UAS when the
          Request-URI is replaced with a contact.</t>

          <t><xref target="RFC4244"></xref> does not allow for marking
          History-Info entries for easy processing by User Agents.</t>
        </list></t>

      <t>This specification is backwards compatible with <xref
      target="RFC4244"></xref>. The following summarizes the functional
      changes:</t>

      <t><list style="numbers">
          <t>Added a tag to indicate the mechanism by which the target for an
          outgoing request is determined.</t>

          <t>Rather than recommending that entries be removed in the case of
          certain values of the privacy header, recommend that the entries are
          anonymized.</t>

          <t>Updated processing/handling for 3xx responses to ensure accuracy
          of the new tags - i.e., the redirecting entity must add the new
          entry since the proxy does not have access to the information as to
          how the Contact was determined.</t>

          <t>Updated the security section to be equivalent to the security
          recommendations for other SIP headers inserted by
          intermediaries.</t>
        </list></t>

      <t>The first 2 changes are intended to facilitate application usage of
      the History-Info header and eliminate the need to make assumptions based
      upon the order of the entries and ensure that the most complete set of
      information is available to the applications.</t>

      <t>In addition, editorial changes were done to both condense and clarify
      the text and examples were simplified and updated to reflect the
      protocol changes.</t>

      <section title="Backwards compatibility">
        <t>Proxies conforming to this specification tag the hi-entry
        parameters with an hi-target parameter. The hi-target parameter did
        not exist in <xref target="RFC4244"></xref>; therefore, <xref
        target="RFC4244"></xref> implementations do not tag the hi-entry
        parameters. This tagging allows for distinguishing entries that were
        added by an <xref target="RFC4244"></xref> entity, versus one that was
        added by an entity conforming to this specification.</t>
      </section>
    </section>

    <section title="Changes since last Version">
      <t>NOTE TO THE RFC-Editor: Please remove this section prior to
      publication as an RFC.</t>

      <t>Changes from barnes-sipcore-4244bis-02 to 03:</t>

      <t><list style="numbers">
          <t>Fixed problem with indices in example in <xref
          target="voicemail"></xref>.</t>

          <t>Removed oc and rt from the Hi-target parameter.</t>

          <t>Removed aor tag</t>

          <t>Added index parameter to "mp"</t>

          <t>Added use-cases and call-flows from target-uri into appendix.</t>
        </list></t>

      <t>Changes from barnes-sipcore-4244bis-01 to 02:</t>

      <t><list style="numbers">
          <t>Added hi-aor parameter that gets marked on the "incoming"
          hi-entry.</t>

          <t>Hi-target parameter defined to be either rc, oc, mp, rt, and now
          gets included when adding an entry.</t>

          <t>Added section on backwards compatibility, as well as added the
          recognition and handling of requests that do not support this
          specification in the appropriate sections.</t>

          <t>Updated redirect server/3xx handling to support the new
          parameters - i.e., the redirecting entity must add the new entry
          since the proxy does not have access to the information as to how
          the Contact was determined.</t>

          <t>Added section on normative differences between this document and
          RFC 4244.</t>

          <t>Restructuring of document to be more in line with current IETF
          practices.</t>

          <t>Moved Requirements section into an Appendix.</t>

          <t>Fixed ABNF to remove unintended ordering requirement on hi-index
          that was introduced in attempting to illustrate it was a mandatory
          parameter.</t>
        </list></t>

      <t>Changes from barnes-sipcore-4244bis-00 to 01 :<list style="numbers">
          <t>Clarified "retarget" definition.</t>

          <t>Removed privacy discussion from optionality section - just refer
          to privacy section.</t>

          <t>Removed extraneous text from target-parameter (leftover from
          sip-4244bis). Changed the terminology from the "reason" to the
          "mechanism" to avoid ambiguity with parameter.</t>

          <t>Various changes to clarify some of the text around privacy.</t>

          <t>Reverted proxy response handling text to previous form - just
          changing the privacy aspects to anonymize, rather than remove.</t>

          <t>Other editorial changes to condense and simplify.</t>

          <t>Moved Privacy examples to Appendix.</t>

          <t>Added forking to Basic call example.</t>
        </list></t>

      <t>Changes from barnes-sip-4244bis-00 to barnes-sipcore-4244bis-00:<list
          style="numbers">
          <t>Added tags for each type of retargeting including proxy hops,
          etc. - i.e., a tag is defined for each specific mechanism by which
          the new Request-URI is determined. Note, this is extremely helpful
          in terms of backwards compatibility.</t>

          <t>Fixed all the examples. Made sure loose routing was used in all
          of them.</t>

          <t>Removed example where a proxy using strict routing is using
          History-Info for avoiding trying same route twice.</t>

          <t>Remove redundant Redirect Server example.</t>

          <t>Index are now mandated to start at "1" instead of
          recommended.</t>

          <t>Clarified 3xx behavior as the entity sending the 3XX response
          MUST add the hi-target attribute to the previous hi-entry to ensure
          that it is appropriately tagged (i.e., it's the only one that knows
          how the contact in the 3xx was determined.)</t>

          <t>Removed lots of ambiguity by making many "MAYs" into "SHOULDs"
          and "some "SHOULDs" into "MUSTs".</t>

          <t>Privacy is now recommended to be done by anonymizing entries as
          per RFC 3323 instead of by removing or omitting hi-entry(s).</t>

          <t>Requirement for TLS is now same level as per RFC 3261.</t>

          <t>Clarified behavior for "Privacy" (i.e., that Privacy is for
          Hi-entries, not headers).</t>

          <t>Removed "OPTIONALITY" as specific requirements, since it's rather
          superflous.</t>

          <t>Other editorial changes to remove redundant text/sections.</t>
        </list></t>

      <t>Changes from RFC4244 to barnes-sip-4244bis-00:<list style="numbers">
          <t>Clarified that HI captures both retargeting as well as cases of
          just forwarding a request.</t>

          <t>Added descriptions of the usage of the terms "retarget",
          "forward" and "redirect" to the terminology section.</t>

          <t>Added additional examples for the functionality provided by HI
          for core SIP.</t>

          <t>Added hi-target parameter values to HI header to ABNF and
          protocol description, as well as defining proxy, UAC and UAS
          behavior for the parameter.</t>

          <t>Simplified example call flow in section 4.5. Moved previous call
          flow to appendix.</t>

          <t>Fixed ABNF per RFC4244 errata "dot" -&gt; "." and added new
          parameter.</t>
        </list></t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      &rfc3261;

      &rfc3326;

      &rfc3323;

      &rfc2119;

      &rfc5246;

      &rfc4244;
    </references>

    <references title="Informative References">
      &rfc5627;

      &rfc5630;

      &rfc3087;

      &rfc4240;

      &rfc5039;

      &rfc4458;

      &rfc3761;

      &rfc4769;

      &I-D.ietf-enum-cnam;
    </references>

    <section anchor="requirements" title="Request History Requirements">
      <t>The following list constitutes a set of requirements for a "Request
      History" capability.</t>

      <t><list style="numbers">
          <t>CAPABILITY-req: The "Request History" capability provides a
          capability to inform proxies and UAs involved in processing a
          request about the history/progress of that request. Although this is
          inherently provided when the retarget is in response to a SIP
          redirect, it is deemed useful for non-redirect retargeting
          scenarios, as well.</t>

          <t>GENERATION-req: "Request History" information is generated when
          the request is retargeted. <list style="letters">
              <t>In some scenarios, it might be possible for more than one
              instance of retargeting to occur within the same Proxy. A proxy
              should also generate Request History information for the
              'internal retargeting'.</t>

              <t>An entity (UA or proxy) retargeting in response to a redirect
              or REFER should include any Request History information from the
              redirect/REFER in the new request.</t>
            </list></t>

          <t>ISSUER-req: "Request History" information can be generated by a
          UA or proxy. It can be passed in both requests and responses.</t>

          <t>CONTENT-req: The "Request History" information for each
          occurrence of retargeting shall include the following:<list
              style="letters">
              <t>The new URI or address to which the request is in the process
              of being retargeted,</t>

              <t>The URI or address from which the request was retargeted, and
              wether the retarget URI was an AOR</t>

              <t>The mechanism by which the new URI or address was
              determined,</t>

              <t>The reason for the Request-URI or address modification,</t>

              <t>Chronological ordering of the Request History
              information.</t>
            </list></t>

          <t>REQUEST-VALIDITY-req: Request History is applicable to requests
          not sent within an established dialog (e.g., INVITE, REGISTER,
          MESSAGE, and OPTIONS).</t>

          <t>BACKWARDS-req: Request History information may be passed from the
          generating entity backwards towards the UAC. This is needed to
          enable services that inform the calling party about the dialog
          establishment attempts.</t>

          <t>FORWARDS-req: Request History information may also be included by
          the generating entity in the request, if it is forwarded
          onwards.</t>
        </list></t>

      <section anchor="secreq" title="Security Requirements">
        <t>The Request History information is being inserted by a network
        element retargeting a Request, resulting in a slightly different
        problem than the basic SIP header problem, thus requiring specific
        consideration. It is recognized that these security requirements can
        be generalized to a basic requirement of being able to secure
        information that is inserted by proxies.</t>

        <t>The potential security problems include the following: <list
            style="numbers">
            <t>A rogue application could insert a bogus Request History entry
            either by adding an additional entry as a result of retargeting or
            entering invalid information.</t>

            <t>A rogue application could re-arrange the Request History
            information to change the nature of the end application or to
            mislead the receiver of the information.</t>

            <t>A rogue application could delete some or all of the Request
            History information.</t>
          </list></t>

        <t>Thus, a security solution for "Request History" must meet the
        following requirements: <list style="numbers">
            <t>SEC-req-1: The entity receiving the Request History must be
            able to determine whether any of the previously added Request
            History content has been altered.</t>

            <t>SEC-req-2: The ordering of the Request History information must
            be preserved at each instance of retargeting.</t>

            <t>SEC-req-3: The entity receiving the information conveyed by the
            Request History must be able to authenticate the entity providing
            the request.</t>

            <t>SEC-req-4: To ensure the confidentiality of the Request History
            information, only entities that process the request should have
            visibility to the information.</t>
          </list></t>

        <t>It should be noted that these security requirements apply to any
        entity making use of the Request History information.</t>
      </section>

      <section anchor="privacyreq" title="Privacy Requirements">
        <t>Since the Request-URI that is captured could inadvertently reveal
        information about the originator, there are general privacy
        requirements that MUST be met: <list style="numbers">
            <t>PRIV-req-1: The entity retargeting the Request must ensure that
            it maintains the network-provided privacy (as described in <xref
            target="RFC3323"></xref>) associated with the Request as it is
            retargeted.</t>

            <t>PRIV-req-2: The entity receiving the Request History must
            maintain the privacy associated with the information. In addition,
            local policy at a proxy may identify privacy requirements
            associated with the Request-URI being captured in the Request
            History information.</t>

            <t>PRIV-req-3: Request History information subject to privacy
            shall not be included in ougoing messages unless it is protected
            as described in <xref target="RFC3323"></xref>.</t>
          </list></t>
      </section>
    </section>

    <section anchor="appendix" title="Detailed call flows">
      <t>The scenarios in this section provide sample use cases for the
      History-Info header for informational purposes only. They are not
      intended to be normative.</t>

      <section anchor="fork"
               title="Sequentially Forking (History-Info in Response)">
        <t>This scenario highlights an example where the History-Info in the
        response is useful to an application or user that originated the
        request.</t>

        <t>Alice sends a call to Bob via sip:example.com. The proxy
        sip:example.com sequentially tries Bob on a SIP UA that has bound a
        contact with the sip:bob@example.com AOR, and then several alternate
        addresses (Office and Home) unsuccessfully before sending a response
        to Alice. In this example, note that Office and Home are not the same
        AOR as sip:bob@example.com, but rather different AORs that have been
        configured as alternate addresses for Bob in the proxy. In other
        words, Office and Bob are not bound through SIP Registration with
        Bob's AOR. This type of arrangement is common for example when a
        "routing" rule to a PSTN number is manually configured in a Proxy.</t>

        <t>This scenario is provided to show that by providing the
        History-Info to Alice, the end-user or an application at Alice could
        make a decision on how best to attempt finding Bob. Without this
        mechanism, Alice might well attempt Office (and thus Home) and then
        re-attempt Home on a third manual attempt at reaching Bob. With this
        mechanism, either the end-user or application could know that Bob is
        not answering in the Office, and his busy on his home phone. If there
        were an alternative address for Bob known to this end-user or
        application, that hasn't been attempted, then either the application
        or the end- user could attempt that. The intent here is to highlight
        an example of the flexibility of this mechanism that enables
        applications well beyond SIP as it is certainly well beyond the scope
        of this document to prescribe detailed applications.</t>

        <figure>
          <artwork><![CDATA[
Alice   example.com            Bob     Office    Home
|            |                  |        |        |
| INVITE F1  |                  |        |        |
|----------->|    INVITE F2     |        |        |
|            |----------------->|        |        |
| 100 Trying F3                 |        |        |
|<-----------|  302 Move Temporarily F4  |        |
|            |<-----------------|        |        |
|            |   ACK F5         |        |        |
|            |----------------->|        |        |
|            |       INVITE F6           |        |
|            |-------------------------->|        |
|            |      180 Ringing F7       |        |
|            |<--------------------------|        |
|  180 Ringing F8                        |        |
|<-----------|   retransmit INVITE       |        |
|            |-------------------------->|        |
|            |      ( timeout )          |        |
|            |             INVITE F9              |
|            |----------------------------------->|
|            |           100 Trying F10           |
|            |<-----------------------------------|
|            |           486 Busy Here F11        |
|            |<-----------------------------------|
|  486 Busy Here F12                              |
|<-----------|             ACK F13                |
|            |----------------------------------->|
|  ACK F14   |                                    |
|----------->|                                    |

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
Message Details

F1 INVITE alice -> example.com

INVITE sip:alice@example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
<!-- SDP Not Shown -->

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[F2 INVITE  example.com -> Bob

INVITE sip:bob@192.0.2.4 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4>;index=1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
<!-- SDP Not Shown -->

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F3 100 Trying example.com -> alice

SIP/2.0 100 Trying
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F4 302 Moved Temporarily Bob -> example.com

SIP/2.0 302 Moved Temporarily
Via: SIP/2.0/TCP proxy.example.com:5060
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>;tag=3
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2
Contact: <sip:office@example.com>
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F5 ACK 192.0.2.4 -> Bob

ACK sip:home@example.com SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
CSeq: 1 ACK
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F6 INVITE example.com -> office

INVITE sip:office@192.0.2.3.com SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=2
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5>;index=1.2.1
CSeq: 1 INVITE
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
<!-- SDP Not Shown -->

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F7 180 Ringing office -> example.com

SIP/2.0 180 Ringing
Via: SIP/2.0/TCP proxy.example.com:5060;branch=2
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>;tag=5
Supported: histinfo
Call-ID: 12345600@example.com
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5>;index=1.2.1
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F8 180 Ringing example.com -> alice

SIP/2.0 180 Ringing
Via: SIP/2.0/TCP example.com:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5>;index=1.2.1
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F9 INVITE example.com -> home

INVITE sip:home@192.0.2.6 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=3
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5?Reason=SIP;cause=480>;\
              index=1.2.1>;index=1.2.1
History-Info: <sip:home@example.com>;index=1.3;mp=1.2
History-Info: <sip:home@192.0.2.6>;index=1.3.1
CSeq: 1 INVITE
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
<!-- SDP Not Shown -->

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F10 100 Trying home -> example.com

SIP/2.0 100 Trying
Via: SIP/2.0/TCP proxy.example.com:5060;branch=3
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F11 486 Busy Here home -> example.com

SIP/2.0  486 Busy Here
Via: SIP/2.0/TCP proxy.example.com:5060;branch=3
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5?Reason=SIP;cause=480>;\
              index=1.2.1>;index=1.2.1
History-Info: <sip:home@example.com>;index=1.3;mp=1.2
History-Info: <sip:home@192.0.2.6>;index=1.3.1
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F12 486 Busy Here example.com -> alice

SIP/2.0  486 Busy Here
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
History-Info: <sip:bob@example.com>;index=1
History-Info: <sip:bob@192.0.2.4?Reason=SIP;cause=302>;\
              index=1.1;rc
History-Info: <sip:office@example.com>;index=1.2;mp=1
History-Info: <sip:office@192.0.2.5?Reason=SIP;cause=480>;\
              index=1.2.1>;index=1.2.1
History-Info: <sip:home@example.com>;index=1.3;mp=1.2
History-Info: <sip:home@192.0.2.6>;index=1.3.1
CSeq: 1 INVITE
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F13 ACK example.com -> home

ACK sip:home@example.com SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
CSeq: 1 ACK
Content-Length: 0

]]></artwork>
        </figure>

        <figure>
          <artwork><![CDATA[
F14 ACK alice -> example.com

ACK sip:bob@example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060
From: Alice <sip:alice@example.com>
To: Bob <sip:bob@example.com>
Call-Id: 12345600@example.com
Route: <sip:proxy.example.com;lr>
CSeq: 1 ACK
Content-Length: 0

]]></artwork>
        </figure>
      </section>

      <section anchor="voicemail" title="Voicemail">
        <t>This scenario highlights an example where the History-Info in the
        request is primarily of use by an edge service (e.g., voicemail
        server). It should be noted that this is not intended to be a complete
        specification for this specific edge service as it is quite likely
        that additional information is needed by the edge service.
        History-Info is just one building block that this service can use.</t>

        <t>Alice called Bob, which had been forwarded to Carol, which
        forwarded to VM (voicemail server). Based upon the retargeted URIs and
        Reasons (and other information) in the INVITE, the VM server makes a
        policy decision about what mailbox to use, which greeting to play,
        etc.</t>

        <figure>
          <artwork><![CDATA[
Alice      example.com       Bob          Carol        VM

| INVITE sip:bob@example.com  |             |          |
|------------->|              |             |          |
|              | INVITE sip:bob@192.0.2.3   |          |
|              |------------->|             |          |
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3>;index=1.1;rc
|              |              |             |          |
|  100 Trying  |              |             |          |
|<-------------| 302 Moved Temporarily      |          |
|              |<-------------|             |          |
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3?Reason=SIP;cause=302>;\
                index=1.1;rc
  History-Info: <sip:carol@example.com>;index=1.2
|              |              |             |          |
|              | INVITE sip:Carol@192.0.2.4 |          |
|              |--------------------------->|          |
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3?Reason=SIP;cause=302>;\
                index=1.1;rc
  History-Info: <sip:carol@example.com>;index=1.2;mp=1
  History-Info: <sip:carol@192.0.2.4>;index=1.2.1;rc
|              |              |             |          |
|              |         180 Ringing        |          |
|              |<---------------------------|          |
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3?Reason=SIP;cause=302>;\
                index=1.1;rc
  History-Info: <sip:carol@example.com>;index=1.2;mp=1
  History-Info: <sip:carol@192.0.2.4>;index=1.2.1;rc
|              |              |             |          |
| 180 Ringing  |              |             |          |
|<-------------|              |             |          |
|              |              |             |          |
|  . . .       |              |             |          |
|              |       (timeout)            |          |
|              |              |             |          |
|              | INVITE sip:vm@192.0.2.5               |
|              |-------------------------------------->|
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3?Reason=SIP;cause=302>;\
                index=1.1;rc
  History-Info: <sip:carol@example.com>;index=1.2;mp=1
  History-Info: <sip:carol@192.0.2.4>;index=1.2.1;rc
  History-Info: <sip:vm@example.com>;index=1.3;mp=1.2
  History-Info: <sip:vm@192.0.2.5>;index=1.3.1
|              |              |             |          |
|              |               200 OK                  |
|              |<--------------------------------------|
  History-Info: <sip:bob@example.com>;index=1
  History-Info: <sip:bob@192.0.2.3?Reason=SIP;cause=302>;\
                index=1.1;rc
  History-Info: <sip:carol@example.com>;index=1.2;mp=1
  History-Info: <sip:carol@192.0.2.4>;index=1.2.1;rc
  History-Info: <sip:vm@example.com>;index=1.3;mp=1.2
  History-Info: <sip:vm@192.0.2.5>;index=1.3.1
|   200 OK     |              |             |          |
|<-------------|              |             |          |
|              |              |             |          |
|     ACK      |              |             |          |
|------------->|                    ACK                |
|              |-------------------------------------->|

]]></artwork>
        </figure>
      </section>

      <section anchor="acd" title="Automatic Call Distribution">
        <t>This scenario highlights an example of an Automatic Call
        Distribution service, where the agents are divided into groups based
        upon the type of customers they handle. In this example, the Gold
        customers are given higher priority than Silver customers, so a Gold
        call would get serviced even if all the agents servicing the Gold
        group were busy, by retargeting the request to the Silver Group for
        delivery to an agent. Upon receipt of the call at the agent assigned
        to handle the incoming call, based upon the History-Info header in the
        message, the application at the agent can provide an indication that
        this is a Gold call, from how many groups it might have overflowed
        before reaching the agent, etc. and thus can be handled appropriately
        by the agent.</t>

        <t>For scenarios whereby calls might overflow from the Silver to the
        Gold, clearly the alternate group identification, internal routing, or
        actual agent that handles the call should not be sent to UA1. Thus,
        for this scenario, one would expect that the Proxy would not support
        the sending of the History-Info in the response, even if requested by
        Alice.</t>

        <t>As with the other examples, this is not prescriptive of how one
        would do this type of service but an example of a subset of processing
        that might be associated with such a service. In addition, this
        example is not addressing any aspects of Agent availability, which
        might also be done via a SIP interface.</t>

        <figure>
          <artwork><![CDATA[
Alice       example.com     Gold          Silver       Agent

|              |              |             |            |
| INVITE sip:Gold@example.com |             |            |
|------------->|              |             |            |
| Supported: histinfo 
|              |              |             |            |
|              |  INVITE sip:Gold@example.com            |
|              |------------->|             |            |
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com>;index=1.1
|              |              |             |            |
|              |  302 Moved Temporarily     |            |
|              |<-------------|             |            |
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com?Reason=SIP;cause=302>;\
                index=1.1
  Contact: <sip:Silver@example.com>
               |              |             |            |
|              |  INVITE sip:Silver@example.com          |
|              |--------------------------->|            |
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com?Reason=SIP;cause=302>;\
                index=1.1
  History-Info: <sip:Silver@example.com>;index=2;mp=1
  History-Info: <sip:Silver@silver.example.com>;index=2.1
|              |              |             |            |
|              |              | INVITE sip:Silver@192.0.2.7
|              |              |             |----------->|
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com?Reason=SIP;cause=302>;\
                index=1.1
  History-Info: <sip:Silver@example.com>;index=2;mp=1
  History-Info: <sip:Silver@silver.example.com>;index=2.1
  History-Info: <sip:Silver@192.0.2.7>;index=2.1.1;rc
|              |              |             |            |
|              |              |             |  200 OK    |
|              |              |             |<-----------|
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com?Reason=SIP;cause=302>;\
                index=1.1
  History-Info: <sip:Silver@example.com>;index=2;mp=1
  History-Info: <sip:Silver@silver.example.com>;index=2.1
  History-Info: <sip:Silver@192.0.2.7>;index=2.1.1;rc
|              |              |             |            |
|              |         200 OK             |            |
|              |<---------------------------|            |
  History-Info: <sip:Gold@example.com>;index=1
  History-Info: <sip:Gold@gold.example.com?Reason=SIP;cause=302>;\
                index=1.1
  History-Info: <sip:Silver@example.com>;index=2;mp=1
  History-Info: <sip:Silver@silver.example.com>;index=2.1
  History-Info: <sip:Silver@192.0.2.7>;index=2.1.1;rc
|              |              |             |            |
   200 OK      |              |             |            |
|<-------------|              |             |            |
|              |              |             |            |
|    ACK       |              |             |            |
|------------->|                  ACK                    |
|              |---------------------------------------->|

]]></artwork>
        </figure>
      </section>

      <section anchor="entirePrivacy" title="History-Info with Privacy Header">
        <t>This example provides a basic call scenario such as the one in
        <xref target="basicFlow"></xref> but without forking, with
        sip:biloxi.example.com adding the Privacy header indicating that the
        History-Info header information is anonymized outside the
        biloxi.example.com domain. This scenario highlights the potential
        functionality lost with the use of "history" privacy in the Privacy
        header for the entire request and the need for careful consideration
        on the use of privacy for History-Info.</t>

        <figure anchor="entirePrivacyFlow" title="Example with Privacy Header">
          <artwork><![CDATA[
Alice   atlanta.example.com  biloxi.example.com   Bob
|                |                |                |
|   INVITE sip:bob@biloxi.example.com;p=x          |
|--------------->|                |                |
| Supported: histinfo             |                |
|                |                |                |
|                |   INVITE sip:bob@biloxi.example.com;p=x
|                |--------------->|                |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
|                |                |                |
|                |                | INVITE sip:bob@192.0.2.3
|                |                |--------------->|
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3>;index=1.1.1;rc 
|                |                |                |
|                |                |     200        |
|                |                |<---------------|
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3>;index=1.1.1;rc
|                |                |                |
|                |     200        |                |
|                |<---------------|                |
| History-Info: <sip:anonymous@anonymous.invalid>;index=1
| History-Info: <sip:anonymous@anonymous.invalid>;index=1.1
| History-Info: <sip:anonymous@anonymous.invalid>;index=1.1.1;rc
|                |                |                |
|     200        |                |                |            
|<---------------|                |                |
| History-Info: <sip:anonymous@anonymous.invalid>;index=1
| History-Info: <sip:anonymous@anonymous.invalid>;index=1.1
| History-Info: <sip:anonymous@anonymous.invalid>;index=1.1.1;rc
|                |                |                |
|     ACK        |                |                |
|--------------->|    ACK         |                |
|                |--------------->|     ACK        |
|                |                |--------------->|
]]></artwork>
        </figure>
      </section>

      <section anchor="entryPrivacy"
               title="Privacy Header for a Specific History-Info Entry">
        <t>This example also provides a basic call scenario such as the one in
        <xref target="basicFlow"></xref> but without forking, however, due to
        local policy at sip:biloxi.example.com, only the final hi-entry in the
        History-Info, which is Bob's local URI, contains a priv-value of
        "history", thus providing Alice with some information about the
        history of the request, but anonymizing Bob's local URI.</t>

        <figure anchor="entryPrivacyFlow"
                title="Example with Privacy Header for Specific URI">
          <artwork><![CDATA[
Alice   atlanta.example.com  biloxi.example.com   Bob
|                |                |                |
|   INVITE sip:bob@biloxi.example.com;p=x          |
|--------------->|                |                |
| Supported: histinfo             |                |
|                |                |                |
|                |   INVITE sip:bob@biloxi.example.com;p=x
|                |--------------->|                |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
|                |                |                |
|                |                |   INVITE sip:bob@192.0.2.3
|                |                |--------------->|
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3?Privacy=history>;index=1.1.1;rc    
|                |                |                |
|                |                |     200        |
|                |                |<---------------|
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:bob@192.0.2.3?Privacy=history>;index=1.1.1;rc
|                |                |                |
|                |     200        |                |
|                |<---------------|                |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:anonymous@anynymous.invalid>;index=1.1.1;rc
|                |                |                |
|     200        |                |                |            
|<---------------|                |                |
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1
| History-Info: <sip:bob@biloxi.example.com;p=x>;index=1.1
| History-Info: <sip:anonymous@anynymous.invalid>;index=1.1.1;rc
|                |                |                |
|     ACK        |                |                |
|--------------->|    ACK         |                |
|                |--------------->|     ACK        |
|                |                |--------------->|

]]></artwork>
        </figure>
      </section>

      <section anchor="sec-solvealias" title="Determining the Alias used.">
        <t>SIP user agents are associated with an address-of-record (AOR). It
        is possible for a single UA to actually have multiple AOR associated
        with it. One common usage for this is aliases. For example, a user
        might have an AOR of sip:john@example.com but also have the AORs
        sip:john.smith@example.com and sip:jsmith@example.com. Rather than
        registering against each of these AORs individually, the user would
        register against just one of them, and the home proxy would
        automatically accept incoming calls for any of the aliases, treating
        them identically and ultimately forwarding them towards the UA. This
        is common practice in the Internet Multimedia Subsystem (IMS), where
        it is called implicit registrations and each alias is called a public
        identity.</t>

        <t>It is a common requirement for a UAS, on receipt of a call, to know
        which of its aliases was used to reach it. This knowledge can be used
        to choose ringtones to play, determine call treatment, and so on. For
        example, a user might give out one alias to friends and family only,
        resulting in a special ring that alerts the user to the importance of
        the call.</t>

        <t>Following call-flow and example messages show how History-Info can
        be used to find out the alias used to reach the callee.</t>

        <t>UAS can see which alias was used in the call by looking at the
        hi-entry prior to the last hi-entry with the "rc" tag.</t>

        <figure anchor="fig-alias" title="Alias Example">
          <artwork><![CDATA[
       Alice             Example.com             John
       |                     | REGISTER F1         |
       |                     |<--------------------|
       |                     | 200 OK F2           |
       |                     |-------------------->|
       | INVITE F3           |                     |
       |-------------------->|                     |
       |                     | INVITE F4           |
       |                     |-------------------->|
                    * Rest of flow not shown *	

F1 REGISTER John -> Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John <sip:john@example.com>;tag=a73kszlfl
To: John <sip:john@example.com>
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>
Content-Length: 0


F2 200 OK Example.com -> John
 
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John <sip:john@example.com>;tag=a73kszlfl
To: John <sip:john@example.com>
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>;expires=3600
Content-Length: 0

F3 INVITE Alice -> Example.com 

INVITE sip:john.smith@example.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>
To: John <sip:john.smith@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: <sip:john.smith@example.com>;index=1;
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]
   
F4 INVITE Example.com -> Bob
 
INVITE sip:john@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>
To: John <sip:john.smith@example.com>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:john.smith@example.com>;index=1;
History-Info: <sip:john@192.0.2.1>;index=1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]
                    
]]></artwork>
        </figure>
      </section>

      <section anchor="sec-solvegruu" title="GRUU">
        <t>A variation on the problem in <xref target="sec-solvealias"></xref>
        occurs with Globally Routable User Agent URI (GRUU) <xref
        target="RFC5627"></xref>. A GRUU is a URI assigned to a UA instance
        which has many of the same properties as the AOR, but causes requests
        to be routed only to that specific instance. It is desirable for a UA
        to know whether it was reached because a correspondent sent a request
        to its GRUU or to its AOR. This can be used to drive differing
        authorization policies on whether the request should be accepted or
        rejected, for example. However, like the AOR itself, the GRUU is lost
        in translation at the home proxy. Thus, the UAS cannot know whether it
        was contacted via the GRUU or its AOR.</t>

        <t>Following call-flow and example messages show how History-Info can
        be used to find out the GRUU used to reach the callee.</t>

        <t>GRUU is merely an AoR with a URI parameter that distinguishes the
        target instance, and as any URI parameters are preserved in
        history-info as Request-URI is trasnlated, UA can see if the request
        was addressed to a specific instance (gruu) by evaluating the presence
        of "gr" parameter in the hi-entry prior to the last hi-entry with the
        "rc" tag.</t>

        <figure anchor="fig-gruu" title="GRUU Example">
          <artwork><![CDATA[
       Alice             Example.com             John
       |                     | REGISTER F1         |
       |                     |<--------------------|
       |                     | 200 OK F2           |
       |                     |-------------------->|
       | INVITE F3           |                     |
       |-------------------->|                     |
       |                     | INVITE F4           |
       |                     |-------------------->|
                    * Rest of flow not shown *	

F1 REGISTER John -> Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John <sip:John@example.com>;tag=a73kszlfl
Supported: gruu
To: John <sip:john@example.com>
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>
 ;+sip.instance="<urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>"
Content-Length: 0

F2 200 OK Example.com -> John

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John <sip:john@example.com>;tag=a73kszlfl
To: John <sip:john@example.com> ;tag=b88sn
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>
 ;pub-gruu="sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
 ;temp-gruu=
  "sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
 ;+sip.instance="<urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>"
 ;expires=3600
Content-Length: 0

Assuming Alice has a knowledge of a gruu either through 
prior communication or through other means such as presence 
places a call to John's gruu.

F3 INVITE Alice -> Example.com 
 
INVITE sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6 SIP/2.0
Via: SIP/2.0/TCP  192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>;tag=kkaz-
To: <sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: <sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>;index=1
Contact: Alice <sip:alice@192.0.2.3>
Content-Length: <appropriate value>

F4 INVITE Example.com -> John
  
INVITE sip:john@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>;tag=kkaz-
To: John <sip:john@example.com>
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>;index=1
History-Info: <sip:john@192.0.2.1>;index=1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
                    
]]></artwork>
        </figure>
      </section>

      <section anchor="sec-solvelimit" title="Limited Use Address">
        <t>A limited use address is a SIP URI that is minted on-demand, and
        passed out to a small number (usually one) remote correspondent.
        Incoming calls targeted to that limited use address are accepted as
        long as the UA still desires communications from the remote target.
        Should they no longer wish to be bothered by that remote
        correspondent, the URI is invalidated so that future requests targeted
        to it are rejected.</t>

        <t>Limited use addresses are used in battling voice spam <xref
        target="RFC5039"></xref>. The easiest way to provide them would be for
        a UA to be able to take its AOR, and "mint" a limited use address by
        appending additional parameters to the URI. It could then give out the
        URI to a particular correspondent, and remember that URI locally. When
        an incoming call arrives, the UAS would examine the parameter in the
        URI and determine whether or not the call should be accepted.
        Alternatively, the UA could push authorization rules into the network,
        so that it need not even see incoming requests that are to be
        rejected.</t>

        <t>This approach, especially when executed on the UA, requires that
        parameters attached to the AOR, but not used by the home proxy in
        processing the request, will survive the translation at the home proxy
        and be presented to the UA. This will not be the case with the logic
        in RFC 3261, since the Request-URI is replaced by the registered
        contact, and any such parameters are lost.</t>

        <t>Using the history-info John's UA can easily see if the call was
        addressed to its AoR, GRUU or a temp-gruu and treat the call
        accordingly by looking at the hi-entry prior to the last hi-entry with
        the "rc" tag.</t>

        <figure anchor="fig-luae" title="Limited Use Address Example">
          <artwork><![CDATA[
       Alice             Example.com             John
       |                     | REGISTER F1         |
       |                     |<--------------------|
       |                     | 200 OK F2           |
       |                     |-------------------->|
       | INVITE F3           |                     |
       |-------------------->|                     |
       |                     | INVITE F4           |
       |                     |-------------------->|
                    * Rest of flow not shown *	


F1 REGISTER John -> Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John <sip:John@example.com>;tag=a73kszlfl
Supported: gruu
To: John <sip:john@example.com>
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>
 ;+sip.instance="<urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>"
Content-Length: 0

F2 200 OK Example.com -> John

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John <sip:john@example.com>;tag=a73kszlfl
To: John <sip:john@example.com> ;tag=b88sn
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:john@192.0.2.1>
 ;pub-gruu="sip:john@example.com
 ;gr=urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6"
 ;temp-gruu=
  "sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr"
 ;+sip.instance="<urn:uuid:f81d4fae-7dec-11d0-a765-00a0c91e6bf6>"
 ;expires=3600
Content-Length: 0

 Assuming Alice has a knowledge of a temp-gruu, she places a 
 call to the temp-gruu.

F3 INVITE Alice -> Example.com 
 
INVITE sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com
 ;gr SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>;tag=kkaz-
To: <sip:sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com
 ;gr>
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: 
 <sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr>
 ;index=1
Contact: Alice <sip:alice@192.0.2.3>
Content-Length: <appropriate value>

F4 INVITE Example.com -> John
 
INVITE sip:john@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>;tag=kkaz-
To: John <sip:john@example.com>
Supported: gruu, histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: 
 <sip:tgruu.7hs==jd7vnzga5w7fajsc7-ajd6fabz0f8g5@example.com;gr>
 ;index=1
History-Info: <sip:john@192.0.2.1>;index=1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
                    
]]></artwork>
        </figure>
      </section>

      <section anchor="sec-solvesub" title="Sub-Address">
        <t>Sub-Addressing is very similar to limited use addresses.
        Sub-addresses are addresses within a subdomain that are multiplexed
        into a single address within a parent domain. The concept is best
        illustrated by example. Consider a VoIP service provided to consumers.
        A consumer obtains a single address from its provider, say
        sip:family@example.com. However, Joe is the patriarch of a family with
        four members, and would like to be able to have a separate identifier
        for each member of his family. One way to do that, without requiring
        Joe to purchase new addresses for each member from the provider, is
        for Joe to mint additional URI by adding a parameter to the AOR. For
        example, his wife Judy with have the URI
        sip:family@example.com;member=judy, and Joe himself would have the URI
        sip:family@example.com;member=joe. The SIP server provider would
        receive requests to these URI, and ignoring the unknown parameters (as
        required by <xref target="RFC3261"></xref>) route the request to the
        registered contact, which corresponds to a SIP server in Joes home.
        That server, in turn, can examine the URI parameters and determine
        which phone in the home to route the call to.</t>

        <t>This feature is not specific to VoIP, and has existing in
        Integrated Services Digital Networking (ISDN) for some time. It is
        particularly useful for small enterprises, in addition to families. It
        is also similar in spirit (though not mechanism) to the ubiquitous
        home routers used by consumers, which allow multiple computers in the
        home to "hide" behind the single IP address provided by the service
        provider, by using the TCP and UDP port as a sub-address.</t>

        <t>The sub-addressing feature is not currently feasible in SIP because
        of the fact that any SIP URI parameter used to convey the sub-address
        would be lost at the home proxy, due to the fact that the Request-URI
        is rewritten there.</t>

        <t>Call-flow and example messages below show the how History-Info can
        be used to deliver the sub-address. UAS or Proxy can determine the
        sub-address by looking at the hi-entry prior to the last hi-entry with
        the "rc" tag.</t>

        <figure anchor="fig-solvesub" title="Sub-Address Example">
          <artwork><![CDATA[
  Alice    Example.com     John's Home      Judy         John    
   |            | REGISTER F1  |              |              |
   |            |<-------------|              |              |
   |            | 200 OK F2    |              |              |
   |            |------------->|              |              |
   |            |              | REGISTER F3  |              |
   |            |              |<-------------|              |
   |            |              | 200 OK F4    |              |
   |            |              |------------->|              |
   |            |              |              | REGISTER F5  |
   |            |              |<----------------------------|
   |            |              |              | 200 OK F6    |
   |            |              |---------------------------->|
   | INVITE F7  |              |              |              |
   |----------->|              |              |              |
   |            | INVITE F8    |              |              |
   |            |------------->|              |              |
   |            |              | INVITE F9    |              |
   |            |              |------------->|              |
                    * Rest of flow not shown *	


F1 REGISTER John's Home Server -> Example.com

REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
Max-Forwards: 70
From: John <sip:johnhome@example.com>;tag=a73kszlfl
To: John <sip:johnhome@example.com>
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:johnhome@192.0.2.1>
Content-Length: 0

F2 200 OK Example.com -> John's Home Server

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1;branch=z9hG4bKnashds7
From: John <sip:johnhome@example.com>;tag=a73kszlfl
To: John <sip:johnhome@example.com> ;tag=b88sn
Call-ID: 1j9FpLxk3uxtm8tn@192.0.2.1
CSeq: 1 REGISTER
Contact: <sip:johnhome@192.0.2.1>;expires=3600
Content-Length: 0

We assume that John's server acts as a proxy allowing 
each of the device in the house to register.

F3 REGISTER Judy's phone -> John's Home Server

REGISTER sip:192.168.1.1 SIP/2.0
Via: SIP/2.0/UDP 192.168.1.2;branch=z9hG4bKnasdds
Max-Forwards: 70
From: Judy <sip:judy@192.168.1.1>;tag=a73kszlfl
To: Judy <sip:judy@192.168.1.1>
Call-ID: 12345pLxk3uxtm8tn@192.168.1.2
CSeq: 1 REGISTER
Contact: <sip:judy@192.168.1.2>
Content-Length: 0

F4 200 OK John's Home Server -> Judy's phone

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.2;branch=z9hG4bKnashds7
From: Judy <sip:judy@192.168.1.1>;tag=a73kszlfl
To: Judy <sip:judy@192.168.1.1>tag=b88sn
Call-ID: 12345pLxk3uxtm8tn@192.168.1.2
CSeq: 1 REGISTER
Contact: <sip:judy@192.168.1.2>;expires=3600
Content-Length: 0

F5 REGISTER John's phone -> John's Home Server

REGISTER sip:192.168.1.1 SIP/2.0
Via: SIP/2.0/UDP 192.168.1.3;branch=z9hG4bKnasdds
Max-Forwards: 70
From: Judy <sip:john@192.168.1.1>;tag=a73kszlfl
To: Judy <sip:john@192.168.1.1>
Call-ID: 12346pLxk3uxtm8tn@192.168.1.3
CSeq: 1 REGISTER
Contact: <sip:john@192.168.1.3>
Content-Length: 0

F6 200 OK John's Home Server -> John's phone

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.3;branch=z9hG4bKnashds7
From: John <sip:john@192.168.1.1>;tag=a73kszlfl
To: John <sip:john@192.168.1.1> ;tag=b88sn
Call-ID: 12346pLxk3uxtm8tn@192.168.1.3
CSeq: 1 REGISTER
Contact: <sip:john@192.168.1.3>;expires=3600
Content-Length: 0

F7 INVITE Alice -> Example.com 

INVITE sip:johnhome@example.com;member=judy SIP/2.0
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>
To: Judy <sip:johnhome@example.com;member=judy>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
History-Info: <sip:johnhome@example.com;member=judy>;index=1;
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]
   
F8 INVITE Example.com -> John's Home
 
INVITE sip:johnhome@192.0.2.1 SIP/2.0
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>
To: Judy <sip:johnhome@example.com;member=judy>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>
History-Info: <sip:johnhome@example.com;member=judy>;index=1;
History-Info: <sip:john@192.0.2.1>;index=1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]
 
John's Home server can see that the call was addressed to 
Judy by evaluating the entry prior to the last entry with the 
"rc" tag and forwards the call accordingly.
 
F9 INVITE John's Home -> Judy
 
INVITE sip:judy@192.168.1.2 SIP/2.0
Via: SIP/2.0/TCP 192.168.1.1:5060;branch=abc2334se
Via: SIP/2.0/TCP proxy.example.com:5060;branch=as2334se
Via: SIP/2.0/TCP 192.0.2.3:5060;branch=232sxxeserg
From: Alice <sip:alice@example.com>
To: Judy <sip:johnhome@example.com;member=judy>
Supported: histinfo
Call-Id: 12345600@example.com
CSeq: 1 INVITE
Record-Route: <sip:proxy.example.com;lr>   
History-Info: <sip:johnhome@example.com;member=judy>;index=1;
History-Info: <sip:john@192.0.2.1>;index=1.1;rc
History-Info: <sip:judy@192.168.1.1>;index=1.1.1;mp=1.1
History-Info: <sip:judy@192.168.1.2>;index=1.1.1.1;rc
Contact: Alice <sip:alice@192.0.2.3>
Content-Type: application/sdp
Content-Length: <appropriate value>
   
[SDP Not Shown]
   
]]></artwork>
        </figure>
      </section>

      <section anchor="sec-solveservice" title="Service Invocation">
        <t>Several SIP specifications have been developed which make use of
        complex URIs to address services within the network rather than
        subscribers. The URIs are complex because they contain numerous
        parameters that control the behavior of the service. Examples of this
        include the specification which first introduced the concept, <xref
        target="RFC3087"></xref>, control of network announcements and IVR
        with SIP URI <xref target="RFC4240"></xref>, and control of voicemail
        access with SIP URI <xref target="RFC4458"></xref>.</t>

        <t>A common problem with all of these mechanisms is that once a proxy
        has decided to rewrite the Request-URI to point to the service, it
        cannot be sure that the Request-URI will not be destroyed by a
        downstream proxy which decides to forward the request in some way, and
        does so by rewriting the Request-URI.</t>

        <t>Section on <xref target="voicemail">voicemail</xref> shows how
        History-Info can be used to invocate a service.</t>
      </section>

      <section anchor="sec-solvetollfree" title="Toll Free Number">
        <t>Toll free numbers, also known as 800 or 8xx numbers in the United
        States, are telephone numbers that are free for users to call.</t>

        <t>In the telephone network, toll free numbers are just aliases to
        actual numbers which are used for routing of the call. In order to
        process the call in the PSTN, a switch will perform a query (using a
        protocol called TCAP), which will return either a phone number or the
        identity of a carrier which can handle the call.</t>

        <t>There has been recent work on allowing such PSTN translation
        services to be accessed by SIP proxy servers through IP querying
        mechanisms. ENUM, for example <xref target="RFC3761"></xref> has
        already been proposed as a mechanism for performing Local Number
        Portability (LNP) queries <xref target="RFC4769"></xref>, and recently
        been proposed for performing calling name queries <xref
        target="I-D.ietf-enum-cnam"></xref>. Using it for 8xx number
        translations is a logical next-step.</t>

        <t>Once such a translation has been performed, the call needs to be
        routed towards the target of the request. Normally, this would happen
        by selecting a PSTN gateway which is a good route towards the
        translated number. However, one can imagine all-IP systems where the
        8xx numbers are SIP endpoints on an IP network, in which case the
        translation of the 8xx number would actually be a SIP URI and not a
        phone number. Assuming for the moment it is a PSTN connected entity,
        the call would be routed towards a PSTN gateway. Proper treatment of
        the call in the PSTN (and in particular, correct reconciliation of
        billing records) requires that the call be marked with both the
        original 8xx number AND the target number for the call. However, in
        our example here, since the translation was performed by a SIP proxy
        upstream from the gateway, the original 8xx number would have been
        lost, and the call will not interwork properly with the PSTN.</t>

        <t>Furthermore, even if the translation of the 8xx number was a SIP
        URI, the enterprise or user who utilize the 8xx service would like to
        know whether the call came in via 8xx number in order to treat the
        call differently (for example to play a special announcement..) but if
        the original R-URI is lost through translation, there is no way to
        tell if the call came in via 8xx number.</t>

        <t>Similar problems arise with other "special" numbers and services
        used in the PSTN, such as operator services, pay numbers (9xx numbers
        in the U.S), and short service codes such as 311.</t>

        <t>To find the service number, the UAS can look at the hi-entry prior
        to the first hi-entry with "mp" tag. Technically call can be forwarded
        to these "special" numbers from non "special" numbers, but with the
        way these services authorize trasnlation, it is not common.</t>

        <figure anchor="fig-tollfree" title="Service Number Example">
          <artwork><![CDATA[
      Alice      Toll Free Service   Atlanta.com          John
       |                |              |                   |
       |    INVITE F1   |              |                   |
       |--------------->|   INVITE F2  |                   |
       |                |------------->|                   |
       |                |              |  INVITE F3        |
       |                |              |------------------>|
     
                    * Rest of flow not shown *	
	
F1: INVITE 192.0.2.1 -> proxy.example.com

INVITE sip:+18005551002@example.com;user=phone  SIP/2.0
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice <sip:+15551001@example.com;user=phone>;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: <sip:+18005551002@example.com;user=phone >;index=1 
Contact: <sip:alice@192.0.2.1>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]

F2: INVITE proxy.example.com -> atlanta.com

INVITE sip:+15555551002@atlanta.com SIP/2.0
Via: SIP/2.0/TCP 192.0.2.4:5060;branch=z9hG4bK-ik80k7g-1
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice <sip:+15551001@example.com;user=phone>;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: <sip:+18005551002@example.com;user=phone >;index=1,
              <sip:+15555551002@atlanta.com>;index=1.1;mp=1
Contact: <sip:alice@192.0.2.1>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]

F3: INVITE atlanta.com -> Joe

INVITE sip:joe@192.168.1.2 SIP/2.0
Via: SIP/2.0/TCP 192.168.1.1:5060;branch=z9hG4bK-pxk7g-3
Via: SIP/2.0/TCP 192.0.2.4:5060;branch=z9hG4bK-ik80k7g-1
Via: SIP/2.0/TCP 192.0.2.1:5060;branch=z9hG4bK-74bf9
From: Alice <sip:+15551001@example.com;user=phone>;tag=9fxced76sl
To: sip:+18005551002@example.com;user=phone
Call-ID: c3x842276298220188511
CSeq: 1 INVITE
Max-Forwards: 70
Supported: histinfo
History-Info: <sip:+18005551002@example.com;user=phone >;index=1,
              <sip:+15555551002@atlanta.com>;index=1.1;mp=1,
              <sip:joe@atlanta.com>;index=1.1.1;mp=1.1,
              <sip:joe@192.168.1.2>;index=1.1.2;rc
Contact: <sip:alice@192.0.2.1>
Content-Type: application/sdp
Content-Length: <appropriate value>

[SDP Not Shown]
                    
]]></artwork>
        </figure>
      </section>
    </section>
  </back>
</rfc>
